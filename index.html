<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>综合金融计算器</title>
    <style>
        /* 全局样式 - 简洁现代风格 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            overflow: hidden; /* 关键：去掉浏览器默认的右侧大滚动条 */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .sidebar {
            width: 250px;
            height: 100%; /* 关键：填满父容器高度 */
            background: rgba(255, 255, 255, 0.85); /* 稍微加深一点背景，提升对比度 */
            backdrop-filter: blur(10px);
            padding: 20px;
            
            /* 关键：允许垂直滚动，禁止水平滚动 */
            overflow-y: auto; 
            overflow-x: hidden;
            
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            border-right: 1px solid rgba(255,255,255,0.5);
            flex-shrink: 0; /* 防止侧边栏被挤压 */
            z-index: 10;
        }
                /* 2. 容器强制占满视口高度 */
        .container {
            display: flex;
            height: 100vh; /* 关键：高度等于视口高度 */
            width: 100%;
            overflow: hidden;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 左侧导航 - 玻璃拟态效果 */
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            border-right: 1px solid rgba(255,255,255,0.5);
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #171360;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .nav-section {
            margin-bottom: 20px;
        }

        .nav-title {
            font-size: 12px;
            color: #2709d2;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .nav-item {
            display: block;
            padding: 10px 15px;
            color: #1186a3;
            text-decoration: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.5);
        }

        .nav-item:hover {
            background: rgba(26, 109, 255, 0.1);
            color: #1a6dff;
        }

        .timeline {
            position: relative;
            padding: 20px 0;
            margin-top: 40px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .timeline-header {
            font-size: 20px;
            color: #333;
            margin-bottom: 25px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .timeline-item {
            position: relative;
            padding-left: 30px;
            padding-bottom: 30px;
            border-left: 2px solid #e0e0e0;
        }

        .timeline-item:last-child {
            border-left: 2px solid transparent;
        }

        .timeline-dot {
            position: absolute;
            left: -6px; /* 线宽2px，圆点10px，居中偏移 */
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #1a6dff;
            border: 2px solid #fff;
            box-shadow: 0 0 0 2px #1a6dff;
        }

        .timeline-date {
            font-size: 13px;
            color: #999;
            margin-bottom: 5px;
        }

        .timeline-version {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tag {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: normal;
            color: #fff;
        }
        .tag-new { background: #27ae60; }   /* 绿色：新增 */
        .tag-fix { background: #e74c3c; }   /* 红色：修复 */
        .tag-opt { background: #f39c12; }   /* 橙色：优化 */

        .timeline-content {
            background: rgba(255,255,255,0.6);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .timeline-content ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .timeline-content li {
            font-size: 14px;
            color: #555;
            margin-bottom: 6px;
            line-height: 1.6;
        }
        .nav-item.active {
            background: rgba(26, 109, 255, 0.15);
            color: #1a6dff;
            font-weight: 500;
        }

        /* 主内容区 */
        .main-content {
            flex: 1;
            height: 100%; /* 关键：填满父容器高度 */
            
            /* 关键：允许垂直滚动 */
            overflow-y: auto;
            
            padding: 30px;
            position: relative;
        }
        ::-webkit-scrollbar {
            width: 8px; /* 纵向滚动条宽度 */
            height: 8px; /* 横向滚动条高度 */
        }

        /* 滚动条轨道 */
        ::-webkit-scrollbar-track {
            background: transparent; 
        }

        /* 滚动条滑块 */
        ::-webkit-scrollbar-thumb {
            background: rgba(136, 136, 136, 0.3); 
            border-radius: 4px;
        }

        /* 鼠标悬停在滑块上 */
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(136, 136, 136, 0.6); 
        }
        .module-content {
            display: none;
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .module-content.active {
            display: block;
        }

        .module-header {
            font-size: 28px;
            margin-bottom: 10px;
            color: #5a04a6;
        }

        .module-desc {
            color: #555;
            margin-bottom: 30px;
        }

        /* 表单样式 */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.7);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #1a6dff;
            box-shadow: 0 0 0 3px rgba(26, 109, 255, 0.1);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* 按钮样式 */
        .btn-calculate {
            background: linear-gradient(135deg, #9f0b43, #0d5bd9);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
            box-shadow: 0 4px 10px rgba(15, 85, 206, 0.3);
        }

        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(26, 109, 255, 0.4);
        }

        /* 结果展示 */
        .results-section {
            margin-top: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            border-radius: 12px;
            display: none;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .results-section.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .result-item {
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .result-label {
            font-size: 14px;
            color: #555;
        }

        .result-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a6dff;
            margin-top: 5px;
        }

        .result-formula {
            margin-top: 10px;
            padding: 10px;
            background: rgba(26, 109, 255, 0.05);
            border-radius: 5px;
            font-size: 14px;
            color: #555;
            font-family: 'Courier New', monospace;
            border-left: 3px solid #1a6dff;
        }
        @media (max-width: 768px) {
            html, body {
                overflow: auto; /* 手机上恢复默认滚动 */
                height: auto;
            }
            
            .container {
                height: auto; /* 手机上高度自适应 */
                flex-direction: column;
                overflow: visible;
            }
            
            .sidebar {
                width: 100%;
                height: auto; /* 手机上侧边栏不固定高度 */
                max-height: 50vh; /* 限制最大高度，防止太长 */
                position: fixed; /* 手机上可以用 fixed 定位菜单 */
                top: 50px; /* 给顶部按钮留位置 */
                left: 0;
                bottom: 0;
                transform: translateX(-100%); /* 默认隐藏 */
                transition: transform 0.3s ease;
            }

            .sidebar.hidden {
                display: block; /* 覆盖原来的 display:none */
                transform: translateX(-100%);
            }

            /* 当侧边栏显示时的类（需要JS配合 toggle sidebar） */
            .sidebar.mobile-active { 
                transform: translateX(0);
            }

            .main-content {
                height: auto;
                overflow: visible;
                padding-top: 60px; /* 避开移动端菜单按钮 */
            }
        }
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 15px;
            }

            .sidebar.hidden {
                display: none;
            }

            .main-content {
                padding: 15px;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .mobile-menu-toggle {
                display: block;
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 1000;
                background: rgba(26, 109, 255, 0.9);
                color: white;
                border: none;
                padding: 10px;
                border-radius: 8px;
                cursor: pointer;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            }
        }

        @media (min-width: 769px) {
            .mobile-menu-toggle {
                display: none;
            }
        }

        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 历史记录 */
        .history-item {
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .history-date {
            color: #1a6dff;
            font-size: 12px;
        }

        /* 导出按钮 */
        .export-buttons {
            margin-top: 20px;
        }

        .btn-export {
            background: linear-gradient(135deg, #00c853, #009624);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,200,83,0.2);
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,200,83,0.3);
        }

        /* 提示信息 */
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
            color: #7809e8;
            font-weight: bold;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: rgba(26, 109, 255, 0.9);
            color: white;
            border-radius: 5px;
            white-space: nowrap;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        /* 移动端遮罩层 */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 15px;
                z-index: 1000; /* 确保在遮罩层之上 */
            }

            .sidebar.hidden {
                display: none;
            }

            .main-content {
                padding: 15px;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .mobile-menu-toggle {
                display: block;
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 1001; /* 在遮罩层和侧边栏之上 */
                background: rgba(26, 109, 255, 0.9);
                color: white;
                border: none;
                padding: 10px;
                border-radius: 8px;
                cursor: pointer;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">☰ 菜单</button>
    
    <div class="container">
        <!-- 左侧导航 -->
        <div class="sidebar" id="sidebar">
            <div class="logo">金融专用计算器</div>
            
            <div class="nav-section">
                <div class="nav-title">基础计算</div>
                <a href="#" class="nav-item active" onclick="showModule('compound')">复利计算</a>
                <a href="#" class="nav-item" onclick="showModule('loan')">贷款计算</a>
                <a href="#" class="nav-item" onclick="showModule('bond')">债券定价</a>
                <a href="#" class="nav-item" onclick="showModule('tri_arb')">三角套汇</a>
            </div>
            
            <div class="nav-section">
                <div class="nav-title">投资分析</div>
                <a href="#" class="nav-item" onclick="showModule('portfolio')">投资组合</a>
                <a href="#" class="nav-item" onclick="showModule('capm')">CAPM模型</a>
                <a href="#" class="nav-item" onclick="showModule('ddm')">股票DDM</a>
                <a href="#" class="nav-item" onclick="showModule('beta_calculator')">Beta与风险溢价</a>
            </div>
            
            <div class="nav-section">
                <div class="nav-title">时间价值</div>
                <a href="#" class="nav-item" onclick="showModule('npv')">NPV/IRR</a>
                <a href="#" class="nav-item" onclick="showModule('annuity')">年金计算</a>
                <a href="#" class="nav-item" onclick="showModule('early_pay')">提前还贷计算器</a>
            </div>
            
            <div class="nav-section">
                <div class="nav-title">风险管理</div>
                <a href="#" class="nav-item" onclick="showModule('volatility')">波动率</a>
                <a href="#" class="nav-item" onclick="showModule('option')">期权关键值计算</a>
            </div>
            <div class="nav-section">
                <div class="nav-title">财务与资金</div>
                <a href="#" class="nav-item" onclick="showModule('tax_calc')">个税计算器</a>
                <a href="#" class="nav-item" onclick="showModule('gjj_calc')">公积金计算器</a>
                <a href="#" class="nav-item" onclick="showModule('dupont')">杜邦分析</a>
                <a href="#" class="nav-item" onclick="showModule('kelly')">凯利公式</a>
                <a href="#" class="nav-item" onclick="showModule('real_rate')">真实收益率</a>
            </div>
            <div class="nav-section">
                <div class="nav-title">高级模型</div>
                <a href="#" class="nav-item" onclick="showModule('blackscholes')">Black-Scholes</a>
                <a href="#" class="nav-item" onclick="showModule('var')">VaR风险值</a>
                <a href="#" class="nav-item" onclick="showModule('sharpe')">夏普比率</a>
                <a href="#" class="nav-item" onclick="showModule('wacc')">WACC成本</a>
                <a href="#" class="nav-item" onclick="showModule('copula')">Copula信用模型</a>
            </div>

            <div class="nav-section">
                <div class="nav-title">关于</div>
                <a href="#" class="nav-item" onclick="showModule('team')">产品介绍</a>
            </div>
                    <div class="nav-section">
                <div class="nav-title">历史记录</div>
                <div id="historyList"></div>
            </div>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 复利计算模块 -->
            <div class="module-content active" id="compound">
                <h2 class="module-header">复利计算</h2>
                <p class="module-desc">计算复利终值、现值，支持定期定投</p>
                
                <div class="input-group">
                    <label>现值 (PV) <span class="tooltip" data-tooltip="初始投资金额">?</span></label>
                    <input type="number" id="compoundPV" value="" step="0.01">
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>年利率 (%) <span class="tooltip" data-tooltip="年化收益率">?</span></label>
                        <input type="number" id="compoundRate" value="" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>期限 (年) <span class="tooltip" data-tooltip="投资年限">?</span></label>
                        <input type="number" id="compoundYears" value="" step="0.1">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>定期投入 (PMT) <span class="tooltip" data-tooltip="每期追加投资，0表示一次性投入">?</span></label>
                    <input type="number" id="compoundPMT" value="" step="0.01">
                </div>
                
                <div class="input-group">
                    <label>投入频率</label>
                    <select id="compoundFreq">
                        <option value="12">每月</option>
                        <option value="4">每季</option>
                        <option value="1">每年</option>
                    </select>
                </div>
                
                <button class="btn-calculate" onclick="calculateCompound()">计算复利</button>
                
                <div class="results-section" id="compoundResults"></div>
            </div>
            
            <!-- 贷款计算模块 -->
            <div class="module-content" id="loan">
                <h2 class="module-header">贷款计算器</h2>
                <p class="module-desc">支持等额本息和等额本金两种还款方式</p>
                
                <div class="input-group">
                    <label>贷款总额 (元)</label>
                    <input type="number" id="loanAmount" value="" step="0.01">
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>年利率 (%)</label>
                        <input type="number" id="loanRate" value="" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>贷款期限 (年)</label>
                        <input type="number" id="loanYears" value="" step="1">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>还款方式</label>
                    <select id="loanType">
                        <option value="equal-payment">等额本息</option>
                        <option value="equal-principal">等额本金</option>
                    </select>
                </div>
                
                <button class="btn-calculate" onclick="calculateLoan()">计算还款计划</button>
                
                <div class="results-section" id="loanResults"></div>
            </div>
        <div class="module-content" id="gjj_calc">
            <h2 class="module-header">公积金存缴计算</h2>
            <p class="module-desc">计算个人与公司缴纳明细，评估年度资产积累</p>
            
            <div class="input-group">
                <label>缴纳基数 (元) <span class="tooltip" data-tooltip="通常为上一年度月平均工资，有上下限规定">?</span></label>
                <input type="number" id="gjjBase" placeholder="例如: 10000" step="100">
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label>个人缴存比例 (%)</label>
                    <select id="gjjPersonalRate">
                        <option value="5">5%</option>
                        <option value="6">6%</option>
                        <option value="7">7%</option>
                        <option value="8">8%</option>
                        <option value="9">9%</option>
                        <option value="10">10%</option>
                        <option value="11">11%</option>
                        <option value="12" selected>12% (常见)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>公司缴存比例 (%)</label>
                    <select id="gjjCompanyRate">
                        <option value="5">5%</option>
                        <option value="6">6%</option>
                        <option value="7">7%</option>
                        <option value="8">8%</option>
                        <option value="9">9%</option>
                        <option value="10">10%</option>
                        <option value="11">11%</option>
                        <option value="12" selected>12% (常见)</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom: 20px; font-size: 14px;">
                <a href="javascript:void(0)" onclick="syncGJJRates()" style="color: #4d0348; text-decoration: none;"> 个人与公司比例保持一致</a>
            </div>

            <button class="btn-calculate" onclick="calculateGJJ()">计算存缴明细</button>
            <div class="results-section" id="gjjResults"></div>
        </div>
            <!-- 债券定价模块 -->
            <div class="module-content" id="bond">
                <h2 class="module-header">债券定价与收益率</h2>
                <p class="module-desc">计算债券价格和到期收益率(YTM)</p>
                
                <div class="input-group">
                    <label>面值 (元) <span class="tooltip" data-tooltip="债券到期偿还的本金">?</span></label>
                    <input type="number" id="bondFaceValue" value="" step="0.01">
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>票面利率 (%)</label>
                        <input type="number" id="bondCouponRate" value="" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>剩余期限 (年)</label>
                        <input type="number" id="bondYears" value="" step="0.1">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>市场收益率 (%) <span class="tooltip" data-tooltip="用于定价的折现率">?</span></label>
                    <input type="number" id="bondYield" value="" step="0.01">
                </div>
                
                <button class="btn-calculate" onclick="calculateBond()">计算债券价格</button>
                
                <div class="results-section" id="bondResults"></div>
            </div>
            
            <!-- 投资组合模块 -->
            <div class="module-content" id="portfolio">
                <h2 class="module-header">投资组合分析</h2>
                <p class="module-desc">计算组合预期收益和风险（标准差）</p>
                
                <div class="input-group">
                    <label>资产1权重 (%) <span class="tooltip" data-tooltip="输入权重百分比">?</span></label>
                    <input type="number" id="weight1" value="" step="0.1">
                </div>
                <div class="input-group">
                    <label>资产1预期收益 (%) <span class="tooltip" data-tooltip="年化预期收益率">?</span></label>
                    <input type="number" id="return1" value="" step="0.01">
                </div>
                
                <div class="input-group">
                    <label>资产2权重 (%) <span class="tooltip" data-tooltip="自动计算剩余权重">?</span></label>
                    <input type="number" id="weight2" value="" step="0.1">
                </div>
                <div class="input-group">
                    <label>资产2预期收益 (%) <span class="tooltip" data-tooltip="年化预期收益率">?</span></label>
                    <input type="number" id="return2" value="" step="0.01">
                </div>
                
                <div class="input-group">
                    <label>相关系数 <span class="tooltip" data-tooltip="-1到1之间，0表示不相关">?</span></label>
                    <input type="number" id="correlation" value="" step="0.01" min="-1" max="1">
                </div>
                
                <button class="btn-calculate" onclick="calculatePortfolio()">计算组合指标</button>
                
                <div class="results-section" id="portfolioResults"></div>
            </div>
            
            <!-- CAPM模块 -->
            <div class="module-content" id="capm">
                <h2 class="module-header">CAPM模型</h2>
                <p class="module-desc">资本资产定价模型计算预期收益率</p>
                
                <div class="input-group">
                    <label>无风险利率 (%) <span class="tooltip" data-tooltip="通常取国债收益率">?</span></label>
                    <input type="number" id="riskFreeRate" value="" step="0.01">
                </div>
                
                <div class="input-group">
                    <label>市场风险溢价 (%) <span class="tooltip" data-tooltip="市场预期收益-无风险利率">?</span></label>
                    <input type="number" id="marketRiskPremium" value="" step="0.01">
                </div>
                
                <div class="input-group">
                    <label>Beta系数 <span class="tooltip" data-tooltip="系统风险系数，>1风险高于市场">?</span></label>
                    <input type="number" id="beta" value="" step="0.01">
                </div>
                
                <button class="btn-calculate" onclick="calculateCapm()">计算预期收益</button>
                
                <div class="results-section" id="capmResults"></div>
            </div>
            
            <!-- DDM模块 -->
            <div class="module-content" id="ddm">
                <h2 class="module-header">股票DDM估值</h2>
                <p class="module-desc">股利贴现模型计算股票内在价值</p>
                
                <div class="input-group">
                    <label>最近股利 (元) <span class="tooltip" data-tooltip="最近一期支付的股利">?</span></label>
                    <input type="number" id="recentDividend" value="" step="0.01">
                </div>
                
                <div class="input-group">
                    <label>股利增长率 (%) <span class="tooltip" data-tooltip="永续增长率g，应小于折现率">?</span></label>
                    <input type="number" id="growthRate" value="" step="0.01">
                </div>
                
                <div class="input-group">
                    <label>要求回报率 (%) <span class="tooltip" data-tooltip="投资者的预期回报率">?</span></label>
                    <input type="number" id="requiredReturn" value="" step="0.01">
                </div>
                
                <button class="btn-calculate" onclick="calculateDDM()">计算股票价值</button>
                
                <div class="results-section" id="ddmResults"></div>
            </div>
            
            <!-- NPV/IRR模块 -->
            <div class="module-content" id="npv">
                <h2 class="module-header">NPV与IRR计算</h2>
                <p class="module-desc">净现值和内部收益率分析</p>
                
                <div class="input-group">
                    <label>初始投资 (元) <span class="tooltip" data-tooltip="期初现金流（负值）">?</span></label>
                    <input type="number" id="initialInvestment" value="value" step="0.01">
                </div>
                
                <div class="input-group">
                    <label>现金流序列 (元，逗号分隔) <span class="tooltip" data-tooltip="例如: 20000,25000,30000">?</span></label>
                    <input type="text" id="cashFlows" value="">
                </div>
                
                <div class="input-group">
                    <label>折现率 (%) <span class="tooltip" data-tooltip="资本成本或要求回报率">?</span></label>
                    <input type="number" id="discountRate" value="" step="0.01">
                </div>
                
                <button class="btn-calculate" onclick="calculateNPV()">计算NPV/IRR</button>
                
                <div class="results-section" id="npvResults"></div>
            </div>
            
            <!-- 年金模块 -->
            <div class="module-content" id="annuity">
                <h2 class="module-header">年金计算</h2>
                <p class="module-desc">普通年金、预付年金和永续年金</p>
                
                <div class="input-group">
                    <label>每期支付 (元) <span class="tooltip" data-tooltip="每期固定支付金额">?</span></label>
                    <input type="number" id="annuityPayment" value="" step="0.01">
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>利率 (%)</label>
                        <input type="number" id="annuityRate" value="" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>期数</label>
                        <input type="number" id="annuityPeriods" value="" step="1">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>年金类型</label>
                    <select id="annuityType">
                        <option value="ordinary">普通年金（期末支付）</option>
                        <option value="due">预付年金（期初支付）</option>
                        <option value="perpetuity">永续年金</option>
                    </select>
                </div>
                
                <button class="btn-calculate" onclick="calculateAnnuity()">计算年金价值</button>
                
                <div class="results-section" id="annuityResults"></div>
            </div>
            
            <!-- 波动率模块 -->
            <div class="module-content" id="volatility">
                <h2 class="module-header">波动率与最大回撤</h2>
                <p class="module-desc">计算收益序列的波动率和最大回撤</p>
                
                <div class="input-group">
                    <label>收益率序列 (%，逗号分隔) <span class="tooltip" data-tooltip="例如: 5,8,-3,12,6">?</span></label>
                    <input type="text" id="returnSeries" value="">
                </div>
                
                <button class="btn-calculate" onclick="calculateVolatility()">计算风险指标</button>
                
                <div class="results-section" id="volatilityResults"></div>
            </div>
            
            <!-- 期权关键值计算模块 -->
            <div class="module-content" id="option">
                <h2 class="module-header">期权关键值计算</h2>
                <p class="module-desc">期权Delta和Gamma近似计算</p>
                
                <div class="input-group">
                    <label>标的资产价格</label>
                    <input type="number" id="underlyingPrice" value="" step="0.01">
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>行权价</label>
                        <input type="number" id="strikePrice" value="" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>到期时间 (年)</label>
                        <input type="number" id="timeToExpiry" value="" step="0.01">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>无风险利率 (%)</label>
                    <input type="number" id="optionRiskFree" value="" step="0.01">
                </div>
                
                <div class="input-group">
                    <label>波动率 (%)</label>
                    <input type="number" id="optionVolatility" value="" step="0.01">
                </div>

                
                <button class="btn-calculate" onclick="calculateOptionGreeks()">计算希腊字母</button>
                
                <div class="results-section" id="optionResults"></div>
            </div>
            <div class="module-content" id="early_pay">
                <h2 class="module-header">提前还贷计算器</h2>
                <p class="module-desc">对比"缩短年限"与"减少月供"的利息节省情况，寻找最优还款方案</p>

                <div class="input-row">
                    <div class="input-group">
                        <label>剩余本金 (万元) <span class="tooltip" data-tooltip="当前还没还的本金总额">?</span></label>
                        <input type="number" id="epPrincipal" placeholder="例如: 80" step="1">
                    </div>
                    <div class="input-group">
                        <label>当前利率 (%) <span class="tooltip" data-tooltip="即当前的LPR+基点后的实际执行利率">?</span></label>
                        <input type="number" id="epRate" placeholder="例如: 3.85" step="0.01">
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label>剩余期限 (年) <span class="tooltip" data-tooltip="还剩多少年还清">?</span></label>
                        <input type="number" id="epYears" placeholder="例如: 20" step="1">
                    </div>
                    <div class="input-group">
                        <label>预计提前还款金额 (万元)</label>
                        <input type="number" id="epAmount" placeholder="例如: 20" step="1">
                    </div>
                </div>

                <div class="input-group">
                    <label>原贷款类型</label>
                    <select id="epType">
                        <option value="equal-payment">等额本息 (每月还款额固定)</option>
                        <option value="equal-principal">等额本金 (首月还最多，逐月递减)</option>
                    </select>
                </div>

                <button class="btn-calculate" onclick="calculateEarlyRepayment()">生成对比方案</button>

                <div class="results-section" id="epResults"></div>
            </div>
            <div class="module-content" id="copula">
                <h2 class="module-header">Gaussian Copula 违约相关性模型</h2>
                <p class="module-desc">计算两个资产在特定相关性下的联合违约概率 (Joint Default Probability)</p>
                
                

                <div class="input-row">
                    <div class="input-group">
                        <label>资产 A 违约概率 (PD A) %</label>
                        <input type="number" id="copulaPdA" placeholder="例如: 5" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>资产 B 违约概率 (PD B) %</label>
                        <input type="number" id="copulaPdB" placeholder="例如: 10" step="0.1">
                    </div>
                </div>

                <div class="input-group">
                    <label>违约相关系数 (Correlation, ρ) <span class="tooltip" data-tooltip="-1到1之间。0为无关，1为完全正相关">?</span></label>
                    <input type="number" id="copulaRho" placeholder="例如: 0.3" step="0.05" min="-0.99" max="0.99">
                </div>

                <div style="background: rgba(26, 109, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #666;">
                    <strong>模型说明：</strong> 使用二元高斯 Copula 函数将单体风险映射到联合风险分布。这是 CDO (担保债务凭证) 定价的基础逻辑。
                </div>

                <button class="btn-calculate" onclick="calculateCopula()">计算联合风险</button>
                <div class="results-section" id="copulaResults"></div>
            </div>
            <!-- Black-Scholes完整定价模块 -->
            <div class="module-content" id="blackscholes">
                <h2 class="module-header">Black-Scholes期权定价</h2>
                <p class="module-desc">完整的Black-Scholes期权定价模型</p>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>标的资产价格 (S)</label>
                        <input type="number" id="bsStock" value="" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>行权价 (K)</label>
                        <input type="number" id="bsStrike" value="" step="0.01">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>到期时间 (年)</label>
                        <input type="number" id="bsTime" value="" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>波动率 (%)</label>
                        <input type="number" id="bsVol" value="" step="0.1">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>无风险利率 (%)</label>
                        <input type="number" id="bsRate" value="" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>股息率 (%)</label>
                        <input type="number" id="bsDividend" value="" step="0.01">
                    </div>
                </div>
                
                <button class="btn-calculate" onclick="calculateBlackScholes()">计算期权价格</button>
                
                <div class="results-section" id="bsResults"></div>
            </div>

            <!-- VaR风险值计算模块 -->
            <div class="module-content" id="var">
                <h2 class="module-header">VaR风险价值计算</h2>
                <p class="module-desc">计算投资组合的在险价值</p>
                
                <div class="input-group">
                    <label>投资组合价值 (元)</label>
                    <input type="number" id="varPortfolio" value="" step="1000">
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>预期收益率 (%)</label>
                        <input type="number" id="varReturn" value="" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>波动率 (%)</label>
                        <input type="number" id="varVolatility" value="" step="0.1">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>置信水平</label>
                        <select id="varConfidence">
                            <option value="0.90">90%</option>
                            <option value="0.95" selected>95%</option>
                            <option value="0.99">99%</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>时间范围 (天)</label>
                        <input type="number" id="varDays" value="1" step="1">
                    </div>
                </div>
                
                <button class="btn-calculate" onclick="calculateVaR()">计算VaR</button>
                
                <div class="results-section" id="varResults"></div>
            </div>
            <div class="module-content" id="dupont">
                <h2 class="module-header">杜邦分析体系 (DuPont Analysis)</h2>
                <p class="module-desc">将ROE拆解为销售净利率、资产周转率和权益乘数</p>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>净利润 (Net Income)</label>
                        <input type="number" id="dupontNI" step="1000">
                    </div>
                    <div class="input-group">
                        <label>营业收入 (Revenue)</label>
                        <input type="number" id="dupontRev" step="1000">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>平均总资产 (Assets)</label>
                        <input type="number" id="dupontAssets" step="1000">
                    </div>
                    <div class="input-group">
                        <label>平均股东权益 (Equity)</label>
                        <input type="number" id="dupontEquity" step="1000">
                    </div>
                </div>
                
                <button class="btn-calculate" onclick="calculateDupont()">拆解 ROE</button>
                <div class="results-section" id="dupontResults"></div>
            </div>

            <div class="module-content" id="kelly">
                <h2 class="module-header">凯利公式 (Kelly Criterion)</h2>
                <p class="module-desc">计算投资或博弈中的最优资金下注比例</p>
                
                <div class="input-group">
                    <label>获胜概率 (%) <span class="tooltip" data-tooltip="你预估这笔交易盈利的可能性">?</span></label>
                    <input type="number" id="kellyWinProb" placeholder="例如: 60" step="1">
                </div>
                
                <div class="input-group">
                    <label>赔率 (盈亏比) <span class="tooltip" data-tooltip="盈利金额 / 亏损金额 (例如赚2赔1，赔率为2)">?</span></label>
                    <input type="number" id="kellyOdds" placeholder="例如: 1.5" step="0.1">
                </div>
                
                <div class="input-group">
                    <label>当前本金 (元) <span class="tooltip" data-tooltip="用于计算具体建议投入金额">?</span></label>
                    <input type="number" id="kellyCapital" step="1000">
                </div>
                
                <button class="btn-calculate" onclick="calculateKelly()">计算最佳仓位</button>
                <div class="results-section" id="kellyResults"></div>
            </div>

            <div class="module-content" id="real_rate">
                <h2 class="module-header">真实收益率 (费雪效应)</h2>
                <p class="module-desc">计算扣除通货膨胀后的实际购买力增长</p>
                
                <div class="input-group">
                    <label>名义收益率 (%) <span class="tooltip" data-tooltip="银行存款利率或投资账面回报">?</span></label>
                    <input type="number" id="nominalRate" step="0.1">
                </div>
                
                <div class="input-group">
                    <label>通货膨胀率 (%) <span class="tooltip" data-tooltip="CPI指数或预期通胀">?</span></label>
                    <input type="number" id="inflationRate" step="0.1">
                </div>
                
                <button class="btn-calculate" onclick="calculateRealRate()">计算真实回报</button>
                <div class="results-section" id="realRateResults"></div>
            </div>
            <!-- 夏普比率分析模块 -->
            <div class="module-content" id="sharpe">
                <h2 class="module-header">夏普比率与风险调整收益</h2>
                <p class="module-desc">评估投资组合的风险调整后表现</p>
                
                <div class="input-group">
                    <label>投资组合年化收益率 (%)</label>
                    <input type="number" id="sharpeReturn" value="" step="0.1">
                </div>
                
                <div class="input-group">
                    <label>无风险利率 (%)</label>
                    <input type="number" id="sharpeRiskFree" value="" step="0.1">
                </div>
                
                <div class="input-group">
                    <label>投资组合标准差 (%)</label>
                    <input type="number" id="sharpeStdDev" value="" step="0.1">
                </div>
                
                <div class="input-group">
                    <label>市场基准收益率 (%) <span class="tooltip" data-tooltip="用于计算Treynor和Jensen's Alpha">?</span></label>
                    <input type="number" id="sharpeMarketReturn" value="" step="0.1">
                </div>
                
                <div class="input-group">
                    <label>Beta系数</label>
                    <input type="number" id="sharpeBeta" value="" step="0.01">
                </div>
                
                <button class="btn-calculate" onclick="calculateSharpe()">计算风险指标</button>
                
                <div class="results-section" id="sharpeResults"></div>
            </div>
        <div class="module-content" id="tri_arb">
            <h2 class="module-header">三角套汇计算器</h2>
            <p class="module-desc">计算三种货币间循环兑换的无风险套利机会 (A → B → C → A)</p>
            
            

            <div class="input-group" style="background: rgba(26, 109, 255, 0.05); padding: 15px; border-radius: 8px;">
                <label>1. 初始本金 (货币 A)</label>
                <input type="number" id="arbCapital" placeholder="例如: 100000 (CNY)" step="100">
            </div>

            <div style="margin: 20px 0; border-left: 2px dashed #ccc; padding-left: 20px; margin-left: 10px;">
                <div class="input-group">
                    <label>2. 第一腿汇率 (A → B) <span class="tooltip" data-tooltip="1单位货币A能换多少货币B">?</span></label>
                    <input type="number" id="arbRateAB" placeholder="例如 CNY/USD: 0.14" step="0.0001">
                </div>

                <div class="input-group">
                    <label>3. 第二腿汇率 (B → C) <span class="tooltip" data-tooltip="1单位货币B能换多少货币C">?</span></label>
                    <input type="number" id="arbRateBC" placeholder="例如 USD/EUR: 0.92" step="0.0001">
                </div>

                <div class="input-group">
                    <label>4. 第三腿汇率 (C → A) <span class="tooltip" data-tooltip="1单位货币C能换多少货币A">?</span></label>
                    <input type="number" id="arbRateCA" placeholder="例如 EUR/CNY: 7.85" step="0.0001">
                </div>
            </div>

            <button class="btn-calculate" onclick="calculateTriArb()">检测套利机会</button>
            <div class="results-section" id="arbResults"></div>
        </div>
        <div class="module-content" id="tax_calc">
            <h2 class="module-header">个人所得税计算器</h2>
            <p class="module-desc">支持工资薪金累计预扣法、年终奖单独/合并计税自动划算</p>

            <div class="input-row">
                <div class="input-group">
                    <label>税前月薪 (元) <span class="tooltip" data-tooltip="每月的固定税前收入">?</span></label>
                    <input type="number" id="taxSalary" placeholder="例如: 20000" step="100">
                </div>
                <div class="input-group">
                    <label>五险一金个人扣除 (元) <span class="tooltip" data-tooltip="每月个人承担的社保+公积金总额">?</span></label>
                    <input type="number" id="taxInsurance" placeholder="例如: 4000" step="100">
                </div>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label>专项附加扣除 (元/月) <span class="tooltip" data-tooltip="子女教育、赡养老人、房贷/房租等总和">?</span></label>
                    <input type="number" id="taxSpecial" placeholder="例如: 2000" step="100">
                </div>
                <div class="input-group">
                    <label>年终奖金 (元) <span class="tooltip" data-tooltip="年底一次性发放的奖金">?</span></label>
                    <input type="number" id="taxBonus" placeholder="例如: 50000" step="100">
                </div>
            </div>

            <div style="margin-bottom: 20px; font-size: 13px; color: #666; background: rgba(26, 109, 255, 0.05); padding: 10px; border-radius: 6px;">
                <strong> 说明：</strong> 此计算器采用“累计预扣预缴法”估算全年税负。默认起征点为 5000元/月。
            </div>

            <button class="btn-calculate" onclick="calculateTax()">一键筹划</button>

            <div class="results-section" id="taxResults"></div>
        </div>
            <!-- WACC加权平均资本成本模块 -->
            <div class="module-content" id="wacc">
                <h2 class="module-header">WACC加权平均资本成本</h2>
                <p class="module-desc">计算企业的资本成本</p>
                
                <div class="input-group">
                    <label>权益市值 (万元)</label>
                    <input type="number" id="waccEquity" value="" step="100">
                </div>
                
                <div class="input-group">
                    <label>债务市值 (万元)</label>
                    <input type="number" id="waccDebt" value="" step="100">
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>权益成本 (%) <span class="tooltip" data-tooltip="股东要求回报率">?</span></label>
                        <input type="number" id="waccCostEquity" value="" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>债务成本 (%) <span class="tooltip" data-tooltip="税前债务成本">?</span></label>
                        <input type="number" id="waccCostDebt" value="" step="0.1">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>企业所得税率 (%)</label>
                    <input type="number" id="waccTaxRate" value="" step="0.1">
                </div>
                
                <button class="btn-calculate" onclick="calculateWACC()">计算WACC</button>
                
                <div class="results-section" id="waccResults"></div>
            </div>
        <div class="module-content" id="beta_calculator">
            <h2 class="module-header">Beta系数与市场溢价</h2>
            <p class="module-desc">计算资产相对于市场的系统性风险(Beta)及市场风险溢价</p>

            <div style="margin-bottom: 20px; border-bottom: 1px solid #ddd;">
                <button onclick="toggleBetaTab('calc-beta')" style="padding: 10px 20px; border: none; background: none; color: #1a6dff; font-weight: bold; cursor: pointer;">Beta计算 (回归法)</button>
                <button onclick="toggleBetaTab('calc-mrp')" style="padding: 10px 20px; border: none; background: none; color: #0ee535; cursor: pointer;">市场风险溢价</button>
            </div>

            <div id="calc-beta-section">
                <div class="input-group">
                    <label>资产收益率序列 (%) <span class="tooltip" data-tooltip="个股或组合的历史收益率，逗号分隔">?</span></label>
                    <input type="text" id="assetReturns" placeholder="例如: 2.5, 3.0, -1.2, 4.5, ..." value="">
                </div>
                <div class="input-group">
                    <label>市场收益率序列 (%) <span class="tooltip" data-tooltip="对应同期的基准指数收益率，逗号分隔">?</span></label>
                    <input type="text" id="marketReturns" placeholder="例如: 1.5, 2.0, -0.5, 3.0, ..." value="">
                </div>
                <div class="input-group">
                    <label>无风险利率 (%) <span class="tooltip" data-tooltip="可选，用于计算超额收益Beta">?</span></label>
                    <input type="number" id="betaRiskFree" value="0" step="0.01">
                </div>
                <button class="btn-calculate" onclick="calculateBetaValue()">计算 Beta</button>
                <div class="results-section" id="betaResults"></div>
            </div>

            <div id="calc-mrp-section" style="display: none;">
                <div class="input-group">
                    <label>预期市场回报率 (%) <span class="tooltip" data-tooltip="Rm：市场平均预期回报">?</span></label>
                    <input type="number" id="mrpMarketReturn" value="" step="0.1">
                </div>
                <div class="input-group">
                    <label>无风险利率 (%) <span class="tooltip" data-tooltip="Rf：长期国债收益率">?</span></label>
                    <input type="number" id="mrpRiskFree" value="" step="0.1">
                </div>
                <div class="input-group">
                    <label>国家风险溢价 (%) <span class="tooltip" data-tooltip="可选：新兴市场的额外风险补偿">?</span></label>
                    <input type="number" id="mrpCountryRisk" value="0" step="0.1">
                </div>
                <button class="btn-calculate" onclick="calculateMRPValue()">计算溢价</button>
                <div class="results-section" id="mrpResults"></div>
            </div>
        </div>
<!-- 开发团队介绍模块 -->
<div class="module-content" id="team">
    <h2 class="module-header">开发团队介绍</h2>
    <p class="module-desc">专业的金融科技开发团队</p>
    
    <div style="margin-top: 30px;">
        <!-- 团队概述 -->
        <div class="result-item" style="background: linear-gradient(135deg, rgba(26, 109, 255, 0.1), rgba(26, 109, 255, 0.05)); border-left: 4px solid #1a6dff;">
            <h3 style="color: #1a6dff; margin-bottom: 10px;">团队简介</h3>
            <p style="color: #555; line-height: 1.8;">
                我们是一支专注于金融科技领域的专业开发团队，致力于为用户提供精准、高效的金融计算工具。
                团队成员均具有金融学、计算机科学背景，拥有丰富的量化投资和软件开发经验。
            </p>
        </div>
        
        <!-- 团队成员卡片 -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 30px;">
            <div class="result-item" style="text-align: center; padding: 25px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f1b2e0 0%, #cd71c5 100%); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: bold;">
                    孔
                </div>
                <h4 style="color: #333; margin-bottom: 5px;">湉湉</h4>
                <p style="color: #1a6dff; font-size: 14px; margin-bottom: 10px;">项目总负责人</p>
                <p style="color: #666; font-size: 13px; line-height: 1.6;">
                    可爱的实力派大佬哈<br>
                    谁说可爱的甜美不懂技术<br>
                    项目的核心奠基人之一
                </p>
                <div style="margin-top: 15px; font-size: 12px; color: #999;">
                    擅长：不会的就学，爱学，好学
                </div>
            </div>
            <!-- 成员1 -->
            <div class="result-item" style="text-align: center; padding: 25px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: bold;">
                    王
                </div>
                <h4 style="color: #333; margin-bottom: 5px;">西瓜大王</h4>
                <p style="color: #1a6dff; font-size: 14px; margin-bottom: 10px;">系统架构师</p>
                <p style="color: #666; font-size: 13px; line-height: 1.6;">
                    喜欢玩抽象，爱好debug<br>
                    偏向抽象程序员<br>
                    有问题欢迎联系哈
                </p>
                <div style="margin-top: 15px; font-size: 12px; color: #999;">
                    擅长：算法、风险管理
                </div>
            </div>
            
            <!-- 成员2 -->
            <div class="result-item" style="text-align: center; padding: 25px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: bold;">
                    李
                </div>
                <h4 style="color: #333; margin-bottom: 5px;">七七</h4>
                <p style="color: #1a6dff; font-size: 14px; margin-bottom: 10px;">金融分析师</p>
                <p style="color: #666; font-size: 13px; line-height: 1.6;">
                    爱学习的女孩加一<br>
                    喜欢英语和金融<br>
                    金融的一位大佬
                </p>
                <div style="margin-top: 15px; font-size: 12px; color: #999;">
                    擅长：金融系统架构、性能优化
                </div>
            </div>
            
            <!-- 成员3 -->
            <div class="result-item" style="text-align: center; padding: 25px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: bold;">
                    李
                </div>
                <h4 style="color: #333; margin-bottom: 5px;">kionone</h4>
                <p style="color: #1a6dff; font-size: 14px; margin-bottom: 10px;">量化分析师</p>
                <p style="color: #666; font-size: 13px; line-height: 1.6;">
                    大学生一枚<br>
                    专业的量化大佬<br>
                    平时比较低调
                </p>
                <div style="margin-top: 15px; font-size: 12px; color: #999;">
                    擅长：数据分析、模型构建
                </div>
            </div>
            
            <!-- 成员4 -->
            <div class="result-item" style="text-align: center; padding: 25px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: bold;">
                    李
                </div>
                <h4 style="color: #333; margin-bottom: 5px;">老耿鱼</h4>
                <p style="color: #1a6dff; font-size: 14px; margin-bottom: 10px;">视觉设计师</p>
                <p style="color: #666; font-size: 13px; line-height: 1.6;">
                    喜欢前端设计<br>
                    专业的UI/UX设计师<br>
                    多年前端开发经验
                </p>
                <div style="margin-top: 15px; font-size: 12px; color: #999;">
                    擅长：交互设计、可视化
                </div>
            </div>
            
            <!-- 成员5 -->
            <div class="result-item" style="text-align: center; padding: 25px;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: bold;">
                    卿
                </div>
                <h4 style="color: #333; margin-bottom: 5px;">柳岸</h4>
                <p style="color: #1a6dff; font-size: 14px; margin-bottom: 10px;">投资分析师</p>
                <p style="color: #666; font-size: 13px; line-height: 1.6;">
                    1米9黑皮<br>
                    健身是日常必修课<br>
                    撸铁爱好者本爱
                </p>
                <div style="margin-top: 15px; font-size: 12px; color: #999;">
                    擅长：投资分析和健身
                </div>
            </div>
            
            <!-- 成员6 -->

        </div>
        
        <!-- 联系方式 -->
        <div class="result-item" style="margin-top: 30px; text-align: center; background: rgba(26, 109, 255, 0.05);">
            <h4 style="color: #1a6dff; margin-bottom: 15px;">联系我们</h4>
            <p style="color: #666; line-height: 1.8;">
                 邮箱: 3493966891@qq.com<br>
                 官网: https://wktomo.github.io/finance-calculator/<br>
                 合作联系: 老耿鱼（见邮箱）<br>
                 请不要盗版，谢绝盗版，若有合作请联系团队<br>
                提示：本计算器只能提供参考作用，具体以实际为准
            </p>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.1); color: #999; font-size: 12px;">
                © 金融专用计算器 | 阿星出品，必属精品
            </div>
        </div>
        <div class="timeline">
    <div class="timeline-header">版本更新日志</div>

        <div class="timeline-item">
            <div class="timeline-dot"></div>
            <div class="timeline-date">2025-12-15</div>
            <div class="timeline-version">
                 财务生活版
                <span class="tag tag-new">新增</span>
            </div>
            <div class="timeline-content">
                <ul>
                    <li> <strong>新增 [个税计算器]</strong>：支持2024新个税法，独家提供“年终奖单独计税 vs 并入综合所得”自动比对筹划功能，拒绝多交冤枉钱。</li>
                    <li> <strong>新增 [提前还贷计算器]</strong>：针对降息周期痛点，一键对比“缩短年限”与“减少月供”的利息节省差异，包含机会成本提示。</li>
                    <li> <strong>修复 [公积金计算]</strong>：修复了计算按钮点击无反应的问题，增加了基数上限预警和个人/公司比例一键同步功能。</li>
                    <li> <strong>优化 [移动端体验]</strong>：优化侧边栏在手机端的交互逻辑，增加遮罩层点击关闭功能。</li>
                </ul>
            </div>
        </div>

        <div class="timeline-item">
            <div class="timeline-dot" style="background: #ccc; box-shadow: 0 0 0 2px #ccc;"></div>
            <div class="timeline-date">2025-12-16</div>
            <div class="timeline-version">
                 专业量化版
                <span class="tag tag-new">新增</span>
            </div>
            <div class="timeline-content">
                <ul>
                    <li> <strong>核心升级</strong>：引入高级金融模型库，包括 Black-Scholes 期权定价、VaR 风险价值计算、Copula 违约相关性模型。</li>
                    <li> <strong>分析工具</strong>：上线杜邦分析体系、WACC 资本成本计算、Kelly 凯利公式注码管理。</li>
                    <li> <strong>性能优化</strong>：重构计算核心算法，提升复杂模型的运算速度。</li>
                </ul>
            </div>
        </div>

        <div class="timeline-item">
            <div class="timeline-dot" style="background: #ccc; box-shadow: 0 0 0 2px #ccc;"></div>
            <div class="timeline-date">2025-12-18</div>
            <div class="timeline-version">
                基础功能优化
                <span class="tag tag-new">新增</span>
            </div>
            <div class="timeline-content">
                <ul>
                    <li> <strong>项目初始化</strong>：金融专用计算器正式上线。</li>
                    <li> <strong>基础功能</strong>：复利计算、贷款计算、债券定价等基础模块开发完成。</li>
                </ul>
            </div>
        </div>
    </div>
    </div>
</div>
        </div>
    </div>

    <script>
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // 禁止 F12 和 Ctrl+Shift+I 等快捷键
        document.onkeydown = function(e) {
            if (e.keyCode == 123) { // F12
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { // Ctrl+Shift+I
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { // Ctrl+Shift+C
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { // Ctrl+Shift+J
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { // Ctrl+U (查看源码)
                return false;
            }
        };
        // 全局变量
        let calculationHistory = JSON.parse(localStorage.getItem('financeCalculatorHistory')) || [];

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
        });

        // 侧边栏切换（移动端）
// 侧边栏切换（移动端优化版）
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            // 如果之前是用 hidden 类控制 display:none，现在我们切换一个 active 类来做动画
            if (sidebar.style.display === 'none' || sidebar.classList.contains('hidden')) {
                sidebar.classList.remove('hidden');
                sidebar.style.display = 'block'; // 确保显示
                // 稍微延迟一下添加动画类，以便 display:block 生效
                setTimeout(() => {
                    sidebar.style.transform = 'translateX(0)';
                }, 10);
            } else {
                // 关闭菜单
                sidebar.style.transform = 'translateX(-100%)';
                setTimeout(() => {
                    sidebar.classList.add('hidden');
                }, 300); // 等待动画结束
            }
        }
        // 切换模块
        function showModule(moduleId) {
            // 隐藏所有模块
            document.querySelectorAll('.module-content').forEach(module => {
                module.classList.remove('active');
            });
            
            // 显示选中模块
            document.getElementById(moduleId).classList.add('active');
            
            // 更新导航状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 移动端关闭侧边栏
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.add('hidden');
            }
        }

        // 工具函数：格式化数字
        function formatNumber(num, decimals = 2) {
            return parseFloat(num).toFixed(decimals);
        }

        // 工具函数：添加到历史记录
        function addToHistory(module, result) {
            const history = {
                module: module,
                result: result,
                date: new Date().toLocaleString('zh-CN')
            };
            
            calculationHistory.unshift(history);
            if (calculationHistory.length > 20) {
                calculationHistory = calculationHistory.slice(0, 20);
            }
            
            localStorage.setItem('financeCalculatorHistory', JSON.stringify(calculationHistory));
            loadHistory();
        }

        // 加载历史记录
        function loadHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (calculationHistory.length === 0) {
                historyList.innerHTML = '<div style="color:#999;font-size:12px;">暂无计算历史</div>';
                return;
            }
            
            calculationHistory.slice(0, 5).forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div style="font-weight:500">${item.module}</div>
                    <div style="font-size:12px;color:#666">${item.result}</div>
                    <div class="history-date">${item.date}</div>
                `;
                historyList.appendChild(historyItem);
            });
        }

        // 复利计算
        function calculateCompound() {
            const pv = parseFloat(document.getElementById('compoundPV').value);
            const rate = parseFloat(document.getElementById('compoundRate').value) / 100;
            const years = parseFloat(document.getElementById('compoundYears').value);
            const pmt = parseFloat(document.getElementById('compoundPMT').value);
            const freq = parseInt(document.getElementById('compoundFreq').value);
            
            // 计算复利终值
            const periodicRate = rate / freq;
            const totalPeriods = years * freq;
            
            // FV = PV*(1+r)^n + PMT*[((1+r)^n -1)/r]
            let fv = pv * Math.pow(1 + periodicRate, totalPeriods);
            if (pmt !== 0) {
                fv += pmt * (Math.pow(1 + periodicRate, totalPeriods) - 1) / periodicRate;
            }
            
            const totalPayment = pv + pmt * totalPeriods;
            const totalInterest = fv - totalPayment;
            
            // 展示结果
            const results = `
                <div class="results-section show" id="compoundResults">
                    <div class="result-item">
                        <div class="result-label">终值 (Future Value)</div>
                        <div class="result-value">¥${formatNumber(fv)}</div>
                        <div class="result-formula">FV = PV×(1+r)^n + PMT×[((1+r)^n-1)/r]</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">总投入</div>
                        <div class="result-value">¥${formatNumber(totalPayment)}</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">总利息</div>
                        <div class="result-value">¥${formatNumber(totalInterest)}</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">年均收益率</div>
                        <div class="result-value">${formatNumber(Math.pow(fv / pv, 1 / years) * 100 - 100, 4)}%</div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                        <button class="btn-export" onclick="exportToPDF()">导出PDF</button>
                    </div>
                </div>
            `;
            
            document.getElementById('compoundResults').outerHTML = results;
            addToHistory('复利计算', `终值 ¥${formatNumber(fv)}`);
        }

        // 贷款计算
        // 定义一个全局变量来存储图表实例，方便销毁重建
        let loanChartInstance = null;

        function calculateLoan() {
            // 1. 获取输入
            const amount = parseFloat(document.getElementById('loanAmount').value);
            const annualRate = parseFloat(document.getElementById('loanRate').value) / 100;
            const years = parseInt(document.getElementById('loanYears').value);
            const type = document.getElementById('loanType').value;

            // 简单校验
            if (!amount || !annualRate || !years) {
                alert("请填写完整的贷款金额、利率和年限");
                return;
            }

            const monthlyRate = annualRate / 12;
            const months = years * 12;

            let monthlyPayment = 0;
            let totalPayment = 0;
            let totalInterest = 0;
            let firstPayment = 0;
            let lastPayment = 0;
            let resultDetailsHtml = '';

            // 2. 计算逻辑
            if (type === 'equal-payment') {
                // 等额本息
                monthlyPayment = amount * monthlyRate * Math.pow(1 + monthlyRate, months) / 
                                (Math.pow(1 + monthlyRate, months) - 1);
                totalPayment = monthlyPayment * months;
                totalInterest = totalPayment - amount;

                resultDetailsHtml = `
                    <div class="result-item">
                        <div class="result-label">月供金额</div>
                        <div class="result-value">¥${formatNumber(monthlyPayment)}</div>
                        <div class="result-formula">等额本息：每月固定还款</div>
                    </div>
                `;
            } else if (type === 'equal-principal') {
                // 等额本金
                const principalPayment = amount / months;
                
                // 循环计算总利息
                for (let i = 0; i < months; i++) {
                    const interestPayment = (amount - principalPayment * i) * monthlyRate;
                    totalInterest += interestPayment;
                }

                totalPayment = amount + totalInterest;
                firstPayment = principalPayment + amount * monthlyRate;
                lastPayment = principalPayment + principalPayment * monthlyRate;

                resultDetailsHtml = `
                    <div class="result-item">
                        <div class="result-label">首期还款</div>
                        <div class="result-value">¥${formatNumber(firstPayment)}</div>
                        <div class="result-formula">等额本金：月供递减</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">末期还款</div>
                        <div class="result-value">¥${formatNumber(lastPayment)}</div>
                    </div>
                `;
            }

            // 3. 生成结果 HTML (新增了 canvas 容器)
            const resultsHTML = `
                <div class="results-section show" id="loanResults">
                    <div style="max-width: 300px; margin: 0 auto 20px auto; position: relative;">
                        <canvas id="loanChart"></canvas>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <div class="result-item" style="flex: 1; text-align: center; border-left: 4px solid #36a2eb;">
                            <div class="result-label">贷款本金</div>
                            <div style="font-weight: bold; font-size: 16px;">¥${formatNumber(amount)}</div>
                        </div>
                        <div class="result-item" style="flex: 1; text-align: center; border-left: 4px solid #ff6384;">
                            <div class="result-label">总利息</div>
                            <div style="font-weight: bold; font-size: 16px;">¥${formatNumber(totalInterest)}</div>
                        </div>
                    </div>

                    ${resultDetailsHtml}

                    <div class="result-item">
                        <div class="result-label">还款总额</div>
                        <div class="result-value">¥${formatNumber(totalPayment)}</div>
                    </div>

                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                    </div>
                </div>
            `;

            // 4. 更新 DOM
            document.getElementById('loanResults').outerHTML = resultsHTML;

            // 5. 绘制图表 (关键步骤)
            // 销毁旧图表防止重影
            if (loanChartInstance) {
                loanChartInstance.destroy();
            }

            const ctx = document.getElementById('loanChart').getContext('2d');
            
            // 创建新图表
            loanChartInstance = new Chart(ctx, {
                type: 'doughnut', // 甜甜圈图
                data: {
                    labels: ['贷款本金', '支付利息'],
                    datasets: [{
                        data: [amount, totalInterest], // 数据：本金 vs 利息
                        backgroundColor: [
                            '#36a2eb', // 蓝色
                            '#ff6384'  // 红色
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom', // 图例在下方
                        },
                        title: {
                            display: true,
                            text: '本金与利息比例'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    // 格式化提示框里的金额
                                    if (context.parsed !== null) {
                                        label += '¥' + context.parsed.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // 添加历史记录
            addToHistory('贷款计算', `${type === 'equal-payment' ? '等额本息' : '等额本金'} 总利息 ¥${formatNumber(totalInterest)}`);
        }
        // 债券定价计算
        function calculateBond() {
            const faceValue = parseFloat(document.getElementById('bondFaceValue').value);
            const couponRate = parseFloat(document.getElementById('bondCouponRate').value) / 100;
            const years = parseFloat(document.getElementById('bondYears').value);
            const yieldRate = parseFloat(document.getElementById('bondYield').value) / 100;
            
            // 每年利息
            const annualCoupon = faceValue * couponRate;
            
            // 债券价格 = ∑(利息/(1+收益率)^i) + 面值/(1+收益率)^n
            let price = 0;
            for (let i = 1; i <= years; i++) {
                price += annualCoupon / Math.pow(1 + yieldRate, i);
            }
            price += faceValue / Math.pow(1 + yieldRate, years);
            
            const currentYield = annualCoupon / price;
            const duration = calculateDuration(price, annualCoupon, yieldRate, years, faceValue);
            
            const resultsHTML = `
                <div class="results-section show" id="bondResults">
                    <div class="result-item">
                        <div class="result-label">债券价格</div>
                        <div class="result-value">¥${formatNumber(price)}</div>
                        <div class="result-formula">价格 = ∑(C/(1+y)^t) + F/(1+y)^n</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">当前收益率</div>
                        <div class="result-value">${formatNumber(currentYield * 100, 4)}%</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">久期 (Duration)</div>
                        <div class="result-value">${formatNumber(duration, 2)}</div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                        <button class="btn-export" onclick="exportToPDF()">导出PDF</button>
                    </div>
                </div>
            `;
            
            document.getElementById('bondResults').outerHTML = resultsHTML;
            addToHistory('债券定价', `价格 ¥${formatNumber(price)}`);
        }

        // 计算久期
        function calculateDuration(price, coupon, yieldRate, years, faceValue) {
            let duration = 0;
            for (let i = 1; i <= years; i++) {
                const cashFlow = i === years ? coupon + faceValue : coupon;
                duration += i * cashFlow / Math.pow(1 + yieldRate, i);
            }
            return duration / price;
        }

        // 投资组合计算
        function calculatePortfolio() {
            const w1 = parseFloat(document.getElementById('weight1').value) / 100;
            const r1 = parseFloat(document.getElementById('return1').value) / 100;
            const w2 = parseFloat(document.getElementById('weight2').value) / 100;
            const r2 = parseFloat(document.getElementById('return2').value) / 100;
            const corr = parseFloat(document.getElementById('correlation').value);
            
            // 组合收益
            const portfolioReturn = w1 * r1 + w2 * r2;
            
            // 组合风险（简化计算，假设标准差均为15%）
            const sigma1 = 0.15;
            const sigma2 = 0.15;
            const portfolioVariance = w1 * w1 * sigma1 * sigma1 + w2 * w2 * sigma2 * sigma2 + 
                                     2 * w1 * w2 * corr * sigma1 * sigma2;
            const portfolioRisk = Math.sqrt(portfolioVariance);
            
            const resultsHTML = `
                <div class="results-section show" id="portfolioResults">
                    <div class="result-item">
                        <div class="result-label">组合预期收益</div>
                        <div class="result-value">${formatNumber(portfolioReturn * 100, 4)}%</div>
                        <div class="result-formula">E(Rp) = w1×R1 + w2×R2</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">组合风险（标准差）</div>
                        <div class="result-value">${formatNumber(portfolioRisk * 100, 4)}%</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">夏普比率（假设无风险利率3%）</div>
                        <div class="result-value">${formatNumber((portfolioReturn - 0.03) / portfolioRisk, 4)}</div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                        <button class="btn-export" onclick="exportToPDF()">导出PDF</button>
                    </div>
                </div>
            `;
            
            document.getElementById('portfolioResults').outerHTML = resultsHTML;
            addToHistory('投资组合', `收益 ${formatNumber(portfolioReturn * 100, 2)}%`);
        }

        // CAPM计算
        function calculateCapm() {
            const rf = parseFloat(document.getElementById('riskFreeRate').value) / 100;
            const marketPremium = parseFloat(document.getElementById('marketRiskPremium').value) / 100;
            const beta = parseFloat(document.getElementById('beta').value);
            
            // E(Ri) = Rf + βi(E(Rm) - Rf)
            const expectedReturn = rf + beta * marketPremium;
            
            // 计算风险贡献
            const systematicRisk = beta * marketPremium;
            
            const resultsHTML = `
                <div class="results-section show" id="capmResults">
                    <div class="result-item">
                        <div class="result-label">预期收益率</div>
                        <div class="result-value">${formatNumber(expectedReturn * 100, 4)}%</div>
                        <div class="result-formula">E(Ri) = Rf + β×(Rm - Rf)</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">无风险利率贡献</div>
                        <div class="result-value">${formatNumber(rf * 100, 4)}%</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">风险溢价贡献</div>
                        <div class="result-value">${formatNumber(systematicRisk * 100, 4)}%</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">风险调整后收益</div>
                        <div class="result-value">${beta > 1 ? '高风险' : beta < 1 ? '低风险' : '等于市场风险'}</div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                        <button class="btn-export" onclick="exportToPDF()">导出PDF</button>
                    </div>
                </div>
            `;
            
            document.getElementById('capmResults').outerHTML = resultsHTML;
            addToHistory('CAPM模型', `预期收益 ${formatNumber(expectedReturn * 100, 2)}%`);
        }

        // DDM计算
        function calculateDDM() {
            const d0 = parseFloat(document.getElementById('recentDividend').value);
            const g = parseFloat(document.getElementById('growthRate').value) / 100;
            const r = parseFloat(document.getElementById('requiredReturn').value) / 100;
            
            if (g >= r) {
                alert('错误：增长率必须小于要求回报率');
                return;
            }
            
            // P0 = D1 / (r - g) = D0(1+g) / (r - g)
            const stockValue = d0 * (1 + g) / (r - g);
            const d1 = d0 * (1 + g);
            
            const resultsHTML = `
                <div class="results-section show" id="ddmResults">
                    <div class="result-item">
                        <div class="result-label">股票内在价值</div>
                        <div class="result-value">¥${formatNumber(stockValue)}</div>
                        <div class="result-formula">P0 = D1 / (r - g)</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">预期下期股利</div>
                        <div class="result-value">¥${formatNumber(d1)}</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">要求回报率构成</div>
                        <div class="result-value">股利收益率 ${formatNumber((d1 / stockValue) * 100, 4)}% + 增长率 ${formatNumber(g * 100, 4)}%</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">合理市盈率</div>
                        <div class="result-value">${formatNumber(stockValue / d0, 2)} 倍</div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                        <button class="btn-export" onclick="exportToPDF()">导出PDF</button>
                    </div>
                </div>
            `;
            
            document.getElementById('ddmResults').outerHTML = resultsHTML;
            addToHistory('DDM估值', `股票价值 ¥${formatNumber(stockValue)}`);
        }

        // NPV/IRR计算
        function calculateNPV() {
            const initial = parseFloat(document.getElementById('initialInvestment').value);
            const cashFlowsText = document.getElementById('cashFlows').value;
            const discountRate = parseFloat(document.getElementById('discountRate').value) / 100;
            
            // 解析现金流
            const cashFlows = cashFlowsText.split(',').map(x => parseFloat(x.trim()));
            const allCashFlows = [initial, ...cashFlows];
            
            // 计算NPV
            let npv = initial;
            for (let i = 0; i < cashFlows.length; i++) {
                npv += cashFlows[i] / Math.pow(1 + discountRate, i + 1);
            }
            
            // 使用简化方法估算IRR
            const irr = calculateIRR(allCashFlows);
            const paybackPeriod = calculatePaybackPeriod(allCashFlows);
            
            // 计算盈利指数
            const pi = (npv - initial) / (-initial) + 1;
            
            const resultsHTML = `
                <div class="results-section show" id="npvResults">
                    <div class="result-item">
                        <div class="result-label">净现值 (NPV)</div>
                        <div class="result-value">¥${formatNumber(npv)}</div>
                        <div class="result-formula">NPV = ∑CFt/(1+r)^t</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">内部收益率 (IRR)</div>
                        <div class="result-value">${formatNumber(irr * 100, 4)}%</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">投资回收期</div>
                        <div class="result-value">${paybackPeriod} 年</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">盈利指数 (PI)</div>
                        <div class="result-value">${formatNumber(pi, 4)}</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">投资建议</div>
                        <div class="result-value" style="color: ${npv > 0 ? '#27ae60' : '#e74c3c'}">${npv > 0 ? '接受项目' : '拒绝项目'}</div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                        <button class="btn-export" onclick="exportToPDF()">导出PDF</button>
                    </div>
                </div>
            `;
            
            document.getElementById('npvResults').outerHTML = resultsHTML;
            addToHistory('NPV/IRR', `NPV ¥${formatNumber(npv)}`);
        }

        // 简化IRR计算
        function calculateIRR(cashFlows, maxIterations = 100) {
            const guess = 0.1;
            const tolerance = 0.00001;
            
            let rate = guess;
            
            for (let i = 0; i < maxIterations; i++) {
                let npv = 0;
                let npvDerivative = 0;
                
                for (let t = 0; t < cashFlows.length; t++) {
                    const discountFactor = Math.pow(1 + rate, t);
                    npv += cashFlows[t] / discountFactor;
                    npvDerivative -= t * cashFlows[t] / Math.pow(1 + rate, t + 1);
                }
                
                if (Math.abs(npv) < tolerance) {
                    return rate;
                }
                
                rate = rate - npv / npvDerivative;
            }
            
            return rate;
        }

        // 计算投资回收期
        function calculatePaybackPeriod(cashFlows) {
            let cumulative = 0;
            for (let i = 0; i < cashFlows.length; i++) {
                cumulative += cashFlows[i];
                if (cumulative >= 0) {
                    return i + (cumulative - cashFlows[i]) / cashFlows[i];
                }
            }
            return cashFlows.length;
        }

        // 年金计算
        function calculateAnnuity() {
            const pmt = parseFloat(document.getElementById('annuityPayment').value);
            const rate = parseFloat(document.getElementById('annuityRate').value) / 100;
            const periods = parseInt(document.getElementById('annuityPeriods').value);
            const type = document.getElementById('annuityType').value;
            
            let pv, fv, formula;
            
            if (type === 'perpetuity') {
                // 永续年金：PV = PMT / r
                pv = pmt / rate;
                fv = Infinity;
                formula = '永续年金：PV = PMT / r';
            } else if (type === 'due') {
                // 预付年金
                pv = pmt * (1 - Math.pow(1 + rate, -periods)) / rate * (1 + rate);
                fv = pmt * (Math.pow(1 + rate, periods) - 1) / rate * (1 + rate);
                formula = '预付年金：期初支付';
            } else {
                // 普通年金
                pv = pmt * (1 - Math.pow(1 + rate, -periods)) / rate;
                fv = pmt * (Math.pow(1 + rate, periods) - 1) / rate;
                formula = '普通年金：期末支付';
            }
            
            const resultsHTML = `
                <div class="results-section show" id="annuityResults">
                    <div class="result-item">
                        <div class="result-label">现值 (PV)</div>
                        <div class="result-value">¥${formatNumber(pv)}</div>
                        <div class="result-formula">${formula}</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">终值 (FV)</div>
                        <div class="result-value">${type === 'perpetuity' ? '∞' : '¥' + formatNumber(fv)}</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">总支付额</div>
                        <div class="result-value">¥${formatNumber(pmt * periods)}</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">总利息</div>
                        <div class="result-value">¥${type === 'perpetuity' ? '∞' : formatNumber(fv - pmt * periods)}</div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                        <button class="btn-export" onclick="exportToPDF()">导出PDF</button>
                    </div>
                </div>
            `;
            
            document.getElementById('annuityResults').outerHTML = resultsHTML;
            addToHistory('年金计算', `现值 ¥${formatNumber(pv)}`);
        }

        // 波动率计算
        function calculateVolatility() {
            const returnsText = document.getElementById('returnSeries').value;
            const returns = returnsText.split(',').map(x => parseFloat(x.trim()) / 100);
            
            // 计算平均收益
            const meanReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            
            // 计算标准差（波动率）
            const variance = returns.reduce((sum, ret) => sum + Math.pow(ret - meanReturn, 2), 0) / (returns.length - 1);
            const volatility = Math.sqrt(variance);
            
            // 计算最大回撤
            let maxDrawdown = 0;
            let peak = returns[0];
            
            for (let i = 1; i < returns.length; i++) {
                if (returns[i] > peak) {
                    peak = returns[i];
                } else {
                    const drawdown = (peak - returns[i]) / peak;
                    maxDrawdown = Math.max(maxDrawdown, drawdown);
                }
            }
            
            // 年化指标（假设月度数据）
            const annualizedReturn = meanReturn * 12;
            const annualizedVolatility = volatility * Math.sqrt(12);
            
            const resultsHTML = `
                <div class="results-section show" id="volatilityResults">
                    <div class="result-item">
                        <div class="result-label">平均收益率</div>
                        <div class="result-value">${formatNumber(meanReturn * 100, 4)}%</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">波动率（标准差）</div>
                        <div class="result-value">${formatNumber(volatility * 100, 4)}%</div>
                        <div class="result-formula">σ = √(∑(Ri - R̄)²/(n-1))</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">年化波动率</div>
                        <div class="result-value">${formatNumber(annualizedVolatility * 100, 4)}%</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">最大回撤</div>
                        <div class="result-value">${formatNumber(maxDrawdown * 100, 4)}%</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">收益波动比</div>
                        <div class="result-value">${formatNumber(meanReturn / volatility, 4)}</div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                        <button class="btn-export" onclick="exportToPDF()">导出PDF</button>
                    </div>
                </div>
            `;
            
            document.getElementById('volatilityResults').outerHTML = resultsHTML;
            addToHistory('波动率', `年化波动率 ${formatNumber(annualizedVolatility * 100, 2)}%`);
        }

        // 期权关键值计算计算
        function calculateOptionGreeks() {
            const S = parseFloat(document.getElementById('underlyingPrice').value);
            const K = parseFloat(document.getElementById('strikePrice').value);
            const T = parseFloat(document.getElementById('timeToExpiry').value);
            const r = parseFloat(document.getElementById('optionRiskFree').value) / 100;
            const sigma = parseFloat(document.getElementById('optionVolatility').value) / 100;
            
            // 简化的Black-Scholes计算
            const d1 = (Math.log(S / K) + (r + sigma * sigma / 2) * T) / (sigma * Math.sqrt(T));
            const d2 = d1 - sigma * Math.sqrt(T);
            
            // 标准正态分布函数近似
            function N(x) {
                // 使用近似公式
                const a1 = 0.254829592;
                const a2 = -0.284496736;
                const a3 = 1.421413741;
                const a4 = -1.453152027;
                const a5 = 1.061405429;
                const p = 0.3275911;
                
                const sign = x >= 0 ? 1 : -1;
                x = Math.abs(x) / Math.sqrt(2);
                
                const t = 1 / (1 + p * x);
                const y = 1 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
                
                return 0.5 * (1 + sign * y);
            }
            
            // 看涨期权价格和希腊字母
            const callPrice = S * N(d1) - K * Math.exp(-r * T) * N(d2);
            const delta = N(d1);
            const gamma = Math.exp(-d1 * d1 / 2) / (S * sigma * Math.sqrt(2 * Math.PI * T));
            
            // 看跌期权价格（看跌-看涨平价）
            const putPrice = callPrice - S + K * Math.exp(-r * T);
            const putDelta = delta - 1;
            
            const resultsHTML = `
                <div class="results-section show" id="optionResults">
                    <div class="result-item">
                        <div class="result-label">看涨期权价格</div>
                        <div class="result-value">¥${formatNumber(callPrice)}</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">看跌期权价格</div>
                        <div class="result-value">¥${formatNumber(putPrice)}</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Delta (看涨)</div>
                        <div class="result-value">${formatNumber(delta, 4)}</div>
                        <div class="result-formula">Δ = ∂C/∂S</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">Gamma</div>
                        <div class="result-value">${formatNumber(gamma, 4)}</div>
                        <div class="result-formula">Γ = ∂²C/∂S²</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">看跌期权Delta</div>
                        <div class="result-value">${formatNumber(putDelta, 4)}</div>
                    </div>
                    
                    <div class="guide">
                        <h4>希腊字母解读：</h4>
                        <ul style="color:#666; font-size:14px; margin-top:10px;">
                            <li>Delta：标的资产价格变动1单位，期权价格变动Delta单位</li>
                            <li>Gamma：Delta对标的资产价格变动的敏感度</li>
                        </ul>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                        <button class="btn-export" onclick="exportToPDF()">导出PDF</button>
                    </div>
                </div>
            `;
            
            document.getElementById('optionResults').outerHTML = resultsHTML;
            addToHistory('期权关键值计算', `Delta ${formatNumber(delta, 3)}`);
        }

        // 导出功能
        function exportToPNG() {
            alert('此功能暂时未开发\n敬请关注后续更新优化，阿星出品，必属精品\n本计算仅供参考，具体以实际为主');
        }

        function exportToPDF() {
            alert('此功能暂时未开发\n敬请关注后续更新优化，阿星出品，必属精品\n本计算仅供参考，具体以实际为主');
        }
    function calculateBlackScholes() {
        const S = parseFloat(document.getElementById('bsStock').value);
        const K = parseFloat(document.getElementById('bsStrike').value);
        const T = parseFloat(document.getElementById('bsTime').value);
        const sigma = parseFloat(document.getElementById('bsVol').value) / 100;
        const r = parseFloat(document.getElementById('bsRate').value) / 100;
        const q = parseFloat(document.getElementById('bsDividend').value) / 100;
        
    // 标准正态分布累积函数
    function normCDF(x) {
        const t = 1 / (1 + 0.2316419 * Math.abs(x));
        const d = 0.3989423 * Math.exp(-x * x / 2);
        const prob = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
        return x > 0 ? 1 - prob : prob;
    }
    
    // 计算d1和d2
    const d1 = (Math.log(S / K) + (r - q + sigma * sigma / 2) * T) / (sigma * Math.sqrt(T));
    const d2 = d1 - sigma * Math.sqrt(T);
    
    // 期权价格
    const callPrice = S * Math.exp(-q * T) * normCDF(d1) - K * Math.exp(-r * T) * normCDF(d2);
    const putPrice = K * Math.exp(-r * T) * normCDF(-d2) - S * Math.exp(-q * T) * normCDF(-d1);
    
    // 希腊字母
    const delta_call = Math.exp(-q * T) * normCDF(d1);
    const delta_put = -Math.exp(-q * T) * normCDF(-d1);
    const gamma = Math.exp(-q * T) * Math.exp(-d1 * d1 / 2) / (S * sigma * Math.sqrt(2 * Math.PI * T));
    const vega = S * Math.exp(-q * T) * Math.exp(-d1 * d1 / 2) * Math.sqrt(T) / Math.sqrt(2 * Math.PI);
    const theta_call = -(S * sigma * Math.exp(-q * T) * Math.exp(-d1 * d1 / 2) / (2 * Math.sqrt(2 * Math.PI * T))) - 
                       r * K * Math.exp(-r * T) * normCDF(d2) + q * S * Math.exp(-q * T) * normCDF(d1);
    const rho_call = K * T * Math.exp(-r * T) * normCDF(d2);
    
    const resultsHTML = `
        <div class="results-section show" id="bsResults">
            <div class="result-item">
                <div class="result-label">看涨期权价格 (Call)</div>
                <div class="result-value">¥${formatNumber(callPrice, 4)}</div>
                <div class="result-formula">C = S×e^(-qT)×N(d1) - K×e^(-rT)×N(d2)</div>
            </div>
            
            <div class="result-item">
                <div class="result-label">看跌期权价格 (Put)</div>
                <div class="result-value">¥${formatNumber(putPrice, 4)}</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                <div class="result-item">
                    <div class="result-label">Delta (看涨)</div>
                    <div class="result-value" style="font-size: 18px;">${formatNumber(delta_call, 4)}</div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">Delta (看跌)</div>
                    <div class="result-value" style="font-size: 18px;">${formatNumber(delta_put, 4)}</div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">Gamma</div>
                    <div class="result-value" style="font-size: 18px;">${formatNumber(gamma, 4)}</div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">Vega</div>
                    <div class="result-value" style="font-size: 18px;">${formatNumber(vega / 100, 4)}</div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">Theta (看涨/年)</div>
                    <div class="result-value" style="font-size: 18px;">${formatNumber(theta_call, 4)}</div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">Rho (看涨)</div>
                    <div class="result-value" style="font-size: 18px;">${formatNumber(rho_call / 100, 4)}</div>
                </div>
            </div>
            
            <div class="result-item" style="margin-top: 15px;">
                <div class="result-label">内在价值 vs 时间价值</div>
                <div style="color: #666; font-size: 14px; margin-top: 10px;">
                    看涨内在价值: ¥${formatNumber(Math.max(0, S - K), 2)}<br>
                    看涨时间价值: ¥${formatNumber(Math.max(0, callPrice - Math.max(0, S - K)), 2)}
                </div>
            </div>
            
            <div class="export-buttons">
                <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                <button class="btn-export" onclick="exportToPDF()">导出PDF</button>
            </div>
        </div>
    `;
    
    document.getElementById('bsResults').outerHTML = resultsHTML;
    addToHistory('Black-Scholes', `看涨 ¥${formatNumber(callPrice, 2)}`);
}

// VaR风险值计算
function calculateVaR() {
    const portfolio = parseFloat(document.getElementById('varPortfolio').value);
    const returnRate = parseFloat(document.getElementById('varReturn').value) / 100;
    const volatility = parseFloat(document.getElementById('varVolatility').value) / 100;
    const confidence = parseFloat(document.getElementById('varConfidence').value);
    const days = parseInt(document.getElementById('varDays').value);
    
    // 正态分布的分位数（Z值）
    const zScores = {
        0.90: 1.282,
        0.95: 1.645,
        0.99: 2.326
    };
    const zScore = zScores[confidence];
    
    // 调整到指定时间范围
    const dailyReturn = returnRate / 252;
    const dailyVol = volatility / Math.sqrt(252);
    const adjustedReturn = dailyReturn * days;
    const adjustedVol = dailyVol * Math.sqrt(days);
    
    // VaR计算（参数法）
    const var_abs = portfolio * (zScore * adjustedVol - adjustedReturn);
    const var_pct = (zScore * adjustedVol - adjustedReturn) * 100;
    
    // CVaR（条件VaR）估算
    const cvar_abs = portfolio * adjustedVol * Math.exp(-zScore * zScore / 2) / 
                     (Math.sqrt(2 * Math.PI) * (1 - confidence));
    
    const resultsHTML = `
        <div class="results-section show" id="varResults">
            <div class="result-item">
                <div class="result-label">VaR (${(confidence * 100)}%置信度, ${days}天)</div>
                <div class="result-value">¥${formatNumber(var_abs)}</div>
                <div class="result-formula">在${days}天内，有${(confidence * 100)}%的把握损失不超过此金额</div>
            </div>
            
            <div class="result-item">
                <div class="result-label">VaR百分比</div>
                <div class="result-value">${formatNumber(var_pct, 4)}%</div>
            </div>
            
            <div class="result-item">
                <div class="result-label">CVaR (条件VaR)</div>
                <div class="result-value">¥${formatNumber(cvar_abs)}</div>
                <div class="result-formula">当损失超过VaR时的平均损失</div>
            </div>
            
            <div class="result-item">
                <div class="result-label">风险等级评估</div>
                <div class="result-value" style="color: ${var_pct > 10 ? '#e74c3c' : var_pct > 5 ? '#f39c12' : '#27ae60'}">
                    ${var_pct > 10 ? '高风险' : var_pct > 5 ? '中等风险' : '低风险'}
                </div>
            </div>
            
            <div class="result-item">
                <div class="result-label">风险指标</div>
                <div style="color: #666; font-size: 14px; margin-top: 10px;">
                    日均波动: ${formatNumber(dailyVol * 100, 4)}%<br>
                    ${days}天波动: ${formatNumber(adjustedVol * 100, 4)}%<br>
                    Z值: ${zScore}
                </div>
            </div>
            
            <div class="export-buttons">
                <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                <button class="btn-export" onclick="exportToPDF()">导出PDF</button>
            </div>
        </div>
    `;
    
    document.getElementById('varResults').outerHTML = resultsHTML;
    addToHistory('VaR计算', `VaR ¥${formatNumber(var_abs)}`);
}

// 夏普比率及相关指标计算
function calculateSharpe() {
    const portfolioReturn = parseFloat(document.getElementById('sharpeReturn').value) / 100;
    const riskFreeRate = parseFloat(document.getElementById('sharpeRiskFree').value) / 100;
    const stdDev = parseFloat(document.getElementById('sharpeStdDev').value) / 100;
    const marketReturn = parseFloat(document.getElementById('sharpeMarketReturn').value) / 100;
    const beta = parseFloat(document.getElementById('sharpeBeta').value);
    
    // 夏普比率
    const sharpeRatio = (portfolioReturn - riskFreeRate) / stdDev;
    
    // Treynor比率
    const treynorRatio = (portfolioReturn - riskFreeRate) / beta;
    
    // Jensen's Alpha
    const expectedReturn = riskFreeRate + beta * (marketReturn - riskFreeRate);
    const alpha = portfolioReturn - expectedReturn;
    
    // 信息比率（假设跟踪误差为标准差的80%）
    const trackingError = stdDev * 0.8;
    const informationRatio = (portfolioReturn - marketReturn) / trackingError;
    
    // Sortino比率（假设下行标准差为总标准差的70%）
    const downsideDeviation = stdDev * 0.7;
    const sortinoRatio = (portfolioReturn - riskFreeRate) / downsideDeviation;
    
    const resultsHTML = `
        <div class="results-section show" id="sharpeResults">
            <div class="result-item">
                <div class="result-label">夏普比率 (Sharpe Ratio)</div>
                <div class="result-value">${formatNumber(sharpeRatio, 4)}</div>
                <div class="result-formula">Sharpe = (Rp - Rf) / σp</div>
            </div>
            
            <div class="result-item">
                <div class="result-label">Treynor比率</div>
                <div class="result-value">${formatNumber(treynorRatio, 4)}</div>
                <div class="result-formula">每单位系统风险的超额收益</div>
            </div>
            
            <div class="result-item">
                <div class="result-label">Jensen's Alpha</div>
                <div class="result-value" style="color: ${alpha > 0 ? '#27ae60' : '#e74c3c'}">${formatNumber(alpha * 100, 4)}%</div>
                <div class="result-formula">${alpha > 0 ? '战胜市场' : '跑输市场'}</div>
            </div>
            
            <div class="result-item">
                <div class="result-label">信息比率 (Information Ratio)</div>
                <div class="result-value">${formatNumber(informationRatio, 4)}</div>
            </div>
            
            <div class="result-item">
                <div class="result-label">Sortino比率</div>
                <div class="result-value">${formatNumber(sortinoRatio, 4)}</div>
                <div class="result-formula">考虑下行风险的调整收益</div>
            </div>
            
            <div class="result-item">
                <div class="result-label">综合评级</div>
                <div class="result-value" style="color: ${sharpeRatio > 1.5 ? '#27ae60' : sharpeRatio > 1 ? '#f39c12' : '#e74c3c'}">
                    ${sharpeRatio > 1.5 ? '优秀 ⭐⭐⭐⭐⭐' : sharpeRatio > 1 ? '良好 ⭐⭐⭐⭐' : sharpeRatio > 0.5 ? '一般 ⭐⭐⭐' : '较差 ⭐⭐'}
                </div>
            </div>
            
            <div class="result-item">
                <div class="result-label">指标解读</div>
                <div style="color: #666; font-size: 13px; margin-top: 10px; line-height: 1.8;">
                    • 夏普比率 > 1 表示风险调整后收益较好<br>
                    • Alpha > 0 表示超越市场表现<br>
                    • 信息比率越高，主动管理能力越强<br>
                    • Sortino比率关注下行风险，更适合厌恶损失的投资者
                </div>
            </div>
            
            <div class="export-buttons">
                <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                <button class="btn-export" onclick="exportToPDF()">导出PDF</button>
            </div>
        </div>
    `;
    
    document.getElementById('sharpeResults').outerHTML = resultsHTML;
    addToHistory('夏普比率', `Sharpe ${formatNumber(sharpeRatio, 2)}`);
}

// WACC加权平均资本成本计算
function calculateWACC() {
    const equity = parseFloat(document.getElementById('waccEquity').value);
    const debt = parseFloat(document.getElementById('waccDebt').value);
    const costEquity = parseFloat(document.getElementById('waccCostEquity').value) / 100;
    const costDebt = parseFloat(document.getElementById('waccCostDebt').value) / 100;
    const taxRate = parseFloat(document.getElementById('waccTaxRate').value) / 100;
    
    // 总资本
    const totalCapital = equity + debt;
    
    // 权重
    const equityWeight = equity / totalCapital;
    const debtWeight = debt / totalCapital;
    
    // WACC计算
    const wacc = equityWeight * costEquity + debtWeight * costDebt * (1 - taxRate);
    
    // 税盾价值（年度）
    const taxShield = debt * costDebt * taxRate;
    
    // 资本结构分析
    const debtRatio = debt / totalCapital;
    const equityRatio = equity / totalCapital;
    
    // 税后债务成本
    const afterTaxDebtCost = costDebt * (1 - taxRate);
    
    const resultsHTML = `
        <div class="results-section show" id="waccResults">
            <div class="result-item">
                <div class="result-label">WACC (加权平均资本成本)</div>
                <div class="result-value">${formatNumber(wacc * 100, 4)}%</div>
                <div class="result-formula">WACC = E/V×Re + D/V×Rd×(1-Tc)</div>
            </div>
            
            <div class="result-item">
                <div class="result-label">资本结构</div>
                <div style="color: #666; font-size: 14px; margin-top: 10px;">
                    权益占比: ${formatNumber(equityRatio * 100, 2)}%<br>
                    债务占比: ${formatNumber(debtRatio * 100, 2)}%<br>
                    资产负债率: ${formatNumber((debt / (debt + equity)) * 100, 2)}%
                </div>
            </div>
            
            <div class="result-item">
                <div class="result-label">税后债务成本</div>
                <div class="result-value">${formatNumber(afterTaxDebtCost * 100, 4)}%</div>
            </div>
            
            <div class="result-item">
                <div class="result-label">年度税盾价值</div>
                <div class="result-value">¥${formatNumber(taxShield)}万</div>
                <div class="result-formula">税盾 = 债务 × 债务成本 × 税率</div>
            </div>
            
            <div class="result-item">
                <div class="result-label">资本成本分解</div>
                <div style="color: #666; font-size: 14px; margin-top: 10px;">
                    权益成本贡献: ${formatNumber(equityWeight * costEquity * 100, 4)}%<br>
                    债务成本贡献: ${formatNumber(debtWeight * afterTaxDebtCost * 100, 4)}%
                </div>
            </div>
            
            <div class="result-item">
                <div class="result-label">资本结构建议</div>
                <div class="result-value" style="color: ${debtRatio > 0.6 ? '#e74c3c' : debtRatio > 0.4 ? '#f39c12' : '#27ae60'}">
                    ${debtRatio > 0.6 ? '杠杆偏高，关注偿债风险' : debtRatio > 0.4 ? '资本结构合理' : '可适当增加债务融资'}
                </div>
            </div>
            
            <div class="result-item">
                <div class="result-label">应用场景</div>
                <div style="color: #666; font-size: 13px; margin-top: 10px; line-height: 1.8;">
                    • 项目投资决策的最低回报率要求<br>
                    • 企业估值中的折现率<br>
                    • 资本预算和资本结构优化<br>
                    • EVA经济增加值计算
                </div>
            </div>
            
            <div class="export-buttons">
                <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                <button class="btn-export" onclick="exportToPDF()">导出PDF</button>
            </div>
        </div>
    `;
    
    document.getElementById('waccResults').outerHTML = resultsHTML;
    addToHistory('WACC计算', `WACC ${formatNumber(wacc * 100, 2)}%`);
}
    function toggleBetaTab(tabId) {
    const betaSection = document.getElementById('calc-beta-section');
    const mrpSection = document.getElementById('calc-mrp-section');
    
    if (tabId === 'calc-beta') {
        betaSection.style.display = 'block';
        mrpSection.style.display = 'none';
    } else {
        betaSection.style.display = 'none';
        mrpSection.style.display = 'block';
    }
}

// 2. 计算 Beta 系数 (核心逻辑)
        function calculateBetaValue() {
            const assetInput = document.getElementById('assetReturns').value;
            const marketInput = document.getElementById('marketReturns').value;
            const rf = parseFloat(document.getElementById('betaRiskFree').value) || 0;

            // 解析输入
            if (!assetInput || !marketInput) {
                alert("请输入资产和市场的收益率序列");
                return;
            }

            const assetYi = assetInput.split(',').map(x => parseFloat(x.trim()));
            const marketXi = marketInput.split(',').map(x => parseFloat(x.trim()));

            if (assetYi.length !== marketXi.length) {
                alert(`数据长度不一致！资产数据有 ${assetYi.length} 个，市场数据有 ${marketXi.length} 个。请确保两者一一对应。`);
                return;
            }

            if (assetYi.length < 2) {
                alert("数据样本太少，无法计算统计指标。");
                return;
            }

            const n = assetYi.length;
            
            // 如果无风险利率不为0，计算超额收益 (Ri - Rf) 和 (Rm - Rf)
            // 这里为了简化，直接使用原始收益率计算（Raw Beta），如果用户输入了Rf，可以作为 Adjusted Beta 的参考，
            // 但通常计算器使用斜率公式 Slope(Ra, Rm)
            
            // 计算均值
            const sumX = marketXi.reduce((a, b) => a + b, 0);
            const sumY = assetYi.reduce((a, b) => a + b, 0);
            const meanX = sumX / n;
            const meanY = sumY / n;

            // 计算协方差和方差
            let numerator = 0; // Cov(X,Y) 的分子
            let denominator = 0; // Var(X) 的分子
            
            for (let i = 0; i < n; i++) {
                numerator += (marketXi[i] - meanX) * (assetYi[i] - meanY);
                denominator += Math.pow((marketXi[i] - meanX), 2);
            }

            const beta = numerator / denominator;
            
            // 计算 Alpha (截距) = MeanY - Beta * MeanX
            const alpha = meanY - beta * meanX;

            // 计算相关系数 (Correlation) 用于辅助分析
            const sumSqDiffY = assetYi.reduce((sum, val) => sum + Math.pow(val - meanY, 2), 0);
            const rSquared = Math.pow(numerator, 2) / (denominator * sumSqDiffY);
            const correlation = Math.sqrt(rSquared) * (beta >= 0 ? 1 : -1);

            // 结果 HTML
            const resultsHTML = `
                <div class="results-section show" id="betaResults">
                    <div class="result-item">
                        <div class="result-label">Beta 系数 (β)</div>
                        <div class="result-value">${formatNumber(beta, 4)}</div>
                        <div class="result-formula">β = Cov(Ri, Rm) / Var(Rm)</div>
                    </div>
                    
                    <div class="input-row">
                        <div class="result-item">
                            <div class="result-label">Alpha (α)</div>
                            <div class="result-value">${formatNumber(alpha, 4)}%</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">相关系数 (R)</div>
                            <div class="result-value">${formatNumber(correlation, 4)}</div>
                        </div>
                    </div>

                    <div class="result-item">
                        <div class="result-label">风险评估</div>
                        <div class="result-value" style="font-size: 16px; color: #555;">
                            ${beta > 1 ? '高波动：波动幅度大于市场' : beta < 1 && beta > 0 ? '低波动：波动幅度小于市场' : beta < 0 ? '反向波动：与市场走势相反' : '无波动'}
                        </div>
                    </div>

                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                    </div>
                </div>
            `;

            document.getElementById('betaResults').outerHTML = resultsHTML;
            addToHistory('Beta计算', `Beta: ${formatNumber(beta, 2)}`);
        }

        // 3. 计算 市场风险溢价 (MRP)
        function calculateMRPValue() {
            const rm = parseFloat(document.getElementById('mrpMarketReturn').value);
            const rf = parseFloat(document.getElementById('mrpRiskFree').value);
            const crp = parseFloat(document.getElementById('mrpCountryRisk').value) || 0;

            if (isNaN(rm) || isNaN(rf)) {
                alert("请输入市场回报率和无风险利率");
                return;
            }

            // 基本公式 MRP = Rm - Rf
            // 包含国家风险: Total MRP = (Rm - Rf) + CRP
            const baseMRP = rm - rf;
            const totalMRP = baseMRP + crp;

            // 结果 HTML
            const resultsHTML = `
                <div class="results-section show" id="mrpResults">
                    <div class="result-item">
                        <div class="result-label">市场风险溢价 (MRP)</div>
                        <div class="result-value">${formatNumber(totalMRP, 2)}%</div>
                        <div class="result-formula">MRP = E(Rm) - Rf ${crp !== 0 ? '+ CRP' : ''}</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">计算细节</div>
                        <div style="color: #666; font-size: 14px; margin-top: 10px;">
                            市场预期回报: ${rm}%<br>
                            - 无风险利率: ${rf}%<br>
                            + 国家风险补偿: ${crp}%
                        </div>
                    </div>

                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                    </div>
                </div>
            `;

            document.getElementById('mrpResults').outerHTML = resultsHTML;
            addToHistory('风险溢价计算', `MRP: ${formatNumber(totalMRP, 2)}%`);
        }
                // 1. 杜邦分析计算
        function calculateDupont() {
            const ni = parseFloat(document.getElementById('dupontNI').value);
            const rev = parseFloat(document.getElementById('dupontRev').value);
            const assets = parseFloat(document.getElementById('dupontAssets').value);
            const equity = parseFloat(document.getElementById('dupontEquity').value);
            
            if (!ni || !rev || !assets || !equity) {
                alert("请填写所有数据字段");
                return;
            }

            // 计算三大指标
            const netMargin = ni / rev; // 销售净利率
            const assetTurnover = rev / assets; // 资产周转率
            const equityMultiplier = assets / equity; // 权益乘数
            const roe = netMargin * assetTurnover * equityMultiplier;

            const resultsHTML = `
                <div class="results-section show" id="dupontResults">
                    <div class="result-item" style="background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); border-left: 4px solid #1a6dff;">
                        <div class="result-label">ROE (净资产收益率)</div>
                        <div class="result-value" style="color: #1a6dff;">${formatNumber(roe * 100, 2)}%</div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:15px;">
                        <div class="result-item" style="text-align:center; padding:10px;">
                            <div style="font-size:12px; color:#666;">销售净利率</div>
                            <div style="font-weight:bold; color:#333; margin-top:5px;">${formatNumber(netMargin * 100, 2)}%</div>
                            <div style="font-size:10px; color:#999;">盈利能力</div>
                        </div>
                        <div class="result-item" style="text-align:center; padding:10px;">
                            <div style="font-size:12px; color:#666;">资产周转率</div>
                            <div style="font-weight:bold; color:#333; margin-top:5px;">${formatNumber(assetTurnover, 2)}次</div>
                            <div style="font-size:10px; color:#999;">营运能力</div>
                        </div>
                        <div class="result-item" style="text-align:center; padding:10px;">
                            <div style="font-size:12px; color:#666;">权益乘数</div>
                            <div style="font-weight:bold; color:#333; margin-top:5px;">${formatNumber(equityMultiplier, 2)}</div>
                            <div style="font-size:10px; color:#999;">杠杆水平</div>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-formula">ROE = 净利率 × 周转率 × 权益乘数</div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                    </div>
                </div>
            `;
            document.getElementById('dupontResults').outerHTML = resultsHTML;
            addToHistory('杜邦分析', `ROE ${formatNumber(roe * 100, 2)}%`);
        }
        function checkLimit(base) {
            // 假设某城市上限是 36000
            const UPPER_LIMIT = 36000; 
            if (base > UPPER_LIMIT) {
                return UPPER_LIMIT; // 自动截断
            }
            return base;
        }
        // 2. 凯利公式计算
        function calculateKelly() {
            const p = parseFloat(document.getElementById('kellyWinProb').value) / 100; // 胜率
            const b = parseFloat(document.getElementById('kellyOdds').value); // 赔率
            const capital = parseFloat(document.getElementById('kellyCapital').value) || 0;
            
            // 凯利公式 f* = (bp - q) / b = p - q/b
            // q = 1 - p (败率)
            const q = 1 - p;
            let f = (b * p - q) / b;
            
            // 如果期望收益为负，f会小于0
            const isProfitable = f > 0;
            
            // 凯利通常建议半仓 (Half Kelly) 以降低波动
            const halfKelly = f / 2;

            const resultsHTML = `
                <div class="results-section show" id="kellyResults">
                    <div class="result-item">
                        <div class="result-label">凯利建议仓位 (Full Kelly)</div>
                        <div class="result-value" style="color: ${isProfitable ? '#27ae60' : '#e74c3c'}">
                            ${isProfitable ? formatNumber(f * 100, 2) + '%' : '不建议下注'}
                        </div>
                        ${capital > 0 && isProfitable ? `<div style="margin-top:5px; color:#666;">建议金额: ¥${formatNumber(capital * f)}</div>` : ''}
                    </div>
                    
                    ${isProfitable ? `
                    <div class="result-item">
                        <div class="result-label">半凯利 (稳健建议)</div>
                        <div class="result-value" style="color: #2980b9;">${formatNumber(halfKelly * 100, 2)}%</div>
                        ${capital > 0 ? `<div style="margin-top:5px; color:#666;">建议金额: ¥${formatNumber(capital * halfKelly)}</div>` : ''}
                    </div>
                    ` : ''}

                    <div class="result-item">
                        <div class="result-label">期望收益</div>
                        <div class="result-value">${formatNumber((p * b - q) * 100, 2)}%</div>
                        <div class="result-formula">每次交易的平均预期回报率</div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                    </div>
                </div>
            `;
            document.getElementById('kellyResults').outerHTML = resultsHTML;
            addToHistory('凯利公式', `建议仓位 ${isProfitable ? formatNumber(f * 100, 2) + '%' : '0%'}`);
        }

        // 3. 真实收益率 (费雪效应)
        function calculateRealRate() {
            const nominal = parseFloat(document.getElementById('nominalRate').value) / 100;
            const inflation = parseFloat(document.getElementById('inflationRate').value) / 100;
            
            // 精确公式: (1 + 名义) = (1 + 真实) * (1 + 通胀)
            // 真实 = (1 + 名义) / (1 + 通胀) - 1
            const realRate = (1 + nominal) / (1 + inflation) - 1;
            
            // 购买力减损
            const purchasingPowerLoss = 1 - (1 / (1 + inflation));

            const resultsHTML = `
                <div class="results-section show" id="realRateResults">
                    <div class="result-item">
                        <div class="result-label">真实收益率 (Real Return)</div>
                        <div class="result-value" style="color: ${realRate > 0 ? '#1a6dff' : '#e74c3c'}">
                            ${formatNumber(realRate * 100, 2)}%
                        </div>
                        <div class="result-formula">R_real = (1 + R_nom) / (1 + i) - 1</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">粗略估算 (名义 - 通胀)</div>
                        <div class="result-value">${formatNumber((nominal - inflation) * 100, 2)}%</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">货币购买力贬值</div>
                        <div class="result-value" style="color: #e67e22;">-${formatNumber(purchasingPowerLoss * 100, 2)}%</div>
                        <div style="font-size:12px; color:#666;">当前通胀下货币购买力的损失幅度</div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                    </div>
                </div>
            `;
            document.getElementById('realRateResults').outerHTML = resultsHTML;
            addToHistory('真实收益率', `真实回报 ${formatNumber(realRate * 100, 2)}%`);
        }
            function calculateTriArb() {
        const capital = parseFloat(document.getElementById('arbCapital').value);
        const rateAB = parseFloat(document.getElementById('arbRateAB').value);
        const rateBC = parseFloat(document.getElementById('arbRateBC').value);
        const rateCA = parseFloat(document.getElementById('arbRateCA').value);

        if (!capital || !rateAB || !rateBC || !rateCA) {
            alert("请完整填写本金和三段汇率");
            return;
        }

        // 1. 计算循环兑换后的金额
        // 路径: 本金(A) * (A->B) * (B->C) * (C->A)
        const finalAmount = capital * rateAB * rateBC * rateCA;
        
        // 2. 计算利润
        const profit = finalAmount - capital;
        const profitRate = (profit / capital) * 100;

        // 3. 判断是否存在套利空间 (利润 > 0 且 覆盖交易成本)
        // 这里简单判断是否大于0，实际情况需考虑点差
        const isArbitrage = profit > 0;
        
        // 4. 计算理论无套利汇率 (用于提示)
        // 理论上 C->A 应该等于 1 / ( (A->B) * (B->C) )
        const theoreticalRateCA = 1 / (rateAB * rateBC);

        const resultsHTML = `
            <div class="results-section show" id="arbResults">
                <div class="result-item" style="border-left: 4px solid ${isArbitrage ? '#27ae60' : '#e74c3c'};">
                    <div class="result-label">套利结果判定</div>
                    <div class="result-value" style="color: ${isArbitrage ? '#27ae60' : '#e74c3c'};">
                        ${isArbitrage ? '发现套利机会！' : '无套利机会 (亏损)'}
                    </div>
                    <div class="result-formula">最终持有: ${formatNumber(finalAmount, 2)} (货币A)</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div class="result-item">
                        <div class="result-label">净利润</div>
                        <div class="result-value" style="color: ${profit > 0 ? '#27ae60' : '#e74c3c'}">
                            ${profit > 0 ? '+' : ''}${formatNumber(profit, 2)}
                        </div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">收益率</div>
                        <div class="result-value">${formatNumber(profitRate, 4)}%</div>
                    </div>
                </div>

                <div class="result-item" style="background: #fff8e1;">
                    <div class="result-label">市场分析建议</div>
                    <div style="font-size: 13px; color: #666; margin-top: 8px;">
                        当前实际汇率乘积: <strong>${(rateAB * rateBC * rateCA).toFixed(6)}</strong><br>
                        ${(rateAB * rateBC * rateCA) > 1 ? '乘积 > 1，存在顺时针套利空间' : '乘积 < 1，无顺时针空间(或可尝试逆向)'}
                        <br><br>
                        <strong>理论均衡价格:</strong><br>
                        若消除套利，第三腿(C→A)汇率应调整为: <span style="color:#1a6dff">${formatNumber(theoreticalRateCA, 4)}</span>
                    </div>
                </div>
                
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportToPNG()">导出报告</button>
                </div>
            </div>
        `;
        
        document.getElementById('arbResults').outerHTML = resultsHTML;
        addToHistory('三角套汇', `收益率 ${formatNumber(profitRate, 4)}%`);
    }
function calculateTax() {
    const monthlySalary = parseFloat(document.getElementById('taxSalary').value) || 0;
    const insurance = parseFloat(document.getElementById('taxInsurance').value) || 0;
    const special = parseFloat(document.getElementById('taxSpecial').value) || 0;
    const yearEndBonus = parseFloat(document.getElementById('taxBonus').value) || 0;
    const threshold = 5000; // 起征点

    if (monthlySalary === 0 && yearEndBonus === 0) {
        alert("请输入工资或年终奖金额");
        return;
    }

    // --- 工具函数：根据应纳税所得额计算税额 (年表) ---
    // 2019新个税年度税率表
    function calculateTaxAmount(taxableIncome) {
        if (taxableIncome <= 0) return { tax: 0, rate: 0, quick: 0 };
        
        let rate = 0;
        let quick = 0;
        
        if (taxableIncome <= 36000) { rate = 0.03; quick = 0; }
        else if (taxableIncome <= 144000) { rate = 0.10; quick = 2520; }
        else if (taxableIncome <= 300000) { rate = 0.20; quick = 16920; }
        else if (taxableIncome <= 420000) { rate = 0.25; quick = 31920; }
        else if (taxableIncome <= 660000) { rate = 0.30; quick = 52920; }
        else if (taxableIncome <= 960000) { rate = 0.35; quick = 85920; }
        else { rate = 0.45; quick = 181920; }

        return {
            tax: taxableIncome * rate - quick,
            rate: rate,
            quick: quick
        };
    }
    const yearlySalaryTaxable = Math.max(0, (monthlySalary - insurance - special - threshold) * 12);
    const taxOnSalary = calculateTaxAmount(yearlySalaryTaxable).tax;
    let taxOnBonusSeparate = 0;
    if (yearEndBonus > 0) { 
        let bRate = 0, bQuick = 0;
        const monthIndex = yearEndBonus / 12;
        if (monthIndex <= 3000) { bRate = 0.03; bQuick = 0; }
        else if (monthIndex <= 12000) { bRate = 0.10; bQuick = 210; }
        else if (monthIndex <= 25000) { bRate = 0.20; bQuick = 1410; }
        else if (monthIndex <= 35000) { bRate = 0.25; bQuick = 2660; }
        else if (monthIndex <= 55000) { bRate = 0.30; bQuick = 4410; }
        else if (monthIndex <= 80000) { bRate = 0.35; bQuick = 7160; }
        else { bRate = 0.45; bQuick = 15160; }
        taxOnBonusSeparate = yearEndBonus * bRate - bQuick;
    }
    const totalTaxSeparate = taxOnSalary + taxOnBonusSeparate;
    const handTotalSeparate = (monthlySalary * 12 + yearEndBonus) - (insurance * 12) - totalTaxSeparate;
    const yearlyMergedTaxable = Math.max(0, (monthlySalary * 12 + yearEndBonus) - (insurance * 12) - (special * 12) - (threshold * 12));
    const totalTaxMerged = calculateTaxAmount(yearlyMergedTaxable).tax;
    const handTotalMerged = (monthlySalary * 12 + yearEndBonus) - (insurance * 12) - totalTaxMerged;

    const diff = totalTaxSeparate - totalTaxMerged; // 正数说明单独计税交的多（应该选合并）
    let recommendation = "";
    let bestHand = 0;
    
    if (Math.abs(diff) < 0.01) {
        recommendation = "两种方式税额相同，任选其一";
        bestHand = handTotalSeparate;
    } else if (diff > 0) {
        recommendation = "建议选择【年终奖并入综合所得】，每年可节税 ¥" + formatNumber(diff);
        bestHand = handTotalMerged;
    } else {
        recommendation = "建议选择【年终奖单独计税】，每年可节税 ¥" + formatNumber(-diff);
        bestHand = handTotalSeparate;
    }

    // --- 构建月度明细 (基于工资) ---
    // 简单展示前几个月和最后一个月的预扣情况
    // 实际业务中，累计预扣会导致前几个月税少，后面税多
    
    const resultsHTML = `
        <div class="results-section show" id="taxResults">
            <div class="result-item" style="border-left: 4px solid #1a6dff; background: linear-gradient(135deg, rgba(26,109,255,0.08), rgba(26,109,255,0.02));">
                <div class="result-label" style="color: #1a6dff; font-weight:bold;"> 筹划结论</div>
                <div style="font-size: 16px; margin-top: 5px; color: #333;">${recommendation}</div>
                <div style="margin-top: 10px; font-size: 14px;">预计全年到手收入: <span style="font-size: 20px; color: #27ae60; font-weight: bold;">¥${formatNumber(bestHand)}</span></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                <div class="result-item">
                    <div class="result-label">方式A: 单独计税</div>
                    <div class="result-value" style="font-size: 18px;">¥${formatNumber(totalTaxSeparate)}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        工资个税: ¥${formatNumber(taxOnSalary)}<br>
                        奖金个税: ¥${formatNumber(taxOnBonusSeparate)}
                    </div>
                </div>
                <div class="result-item">
                    <div class="result-label">方式B: 并入综合</div>
                    <div class="result-value" style="font-size: 18px;">¥${formatNumber(totalTaxMerged)}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        全年一次性计算<br>
                        适用统一税率表
                    </div>
                </div>
            </div>

            <div class="result-item" style="margin-top: 15px;">
                <div class="result-label">工资部分月度概览</div>
                <div style="font-size: 13px; color: #555; margin-top: 8px; line-height: 1.8;">
                    全年应发工资: ¥${formatNumber(monthlySalary * 12)}<br>
                    全年五险一金: ¥${formatNumber(insurance * 12)}<br>
                    全年专项扣除: ¥${formatNumber(special * 12)}<br>
                    <span style="color: #999;">(注：累计预扣法下，年初到手多，年末到手可能变少)</span>
                </div>
            </div>
            
            <div class="export-buttons">
                <button class="btn-export" onclick="exportToPNG()">保存结果</button>
            </div>
        </div>
    `;

    document.getElementById('taxResults').outerHTML = resultsHTML;
    addToHistory('个税计算', `全年到手 ¥${formatNumber(bestHand)}`);
}
        function normInv(p) {
            if (p <= 0) return -Infinity;
            if (p >= 1) return Infinity;
            const a1 = -3.969683028665376e+01, a2 = 2.209460984245205e+02,
                a3 = -2.759285104469687e+02, a4 = 1.383577518672690e+02,
                a5 = -3.066479806614716e+01, a6 = 2.506628277459239e+00;
            const b1 = -5.447609879822406e+01, b2 = 1.615858368580409e+02,
                b3 = -1.556989798598866e+02, b4 = 6.680131188771972e+01,
                b5 = -1.328068155288572e+01;
            const c1 = -7.784894002430293e-03, c2 = -3.223964580411365e-01,
                c3 = -2.400758277161838e+00, c4 = -2.549732539343734e+00,
                c5 = 4.374664141464968e+00, c6 = 2.938163982698783e+00;
            const d1 = 7.784695709041462e-03, d2 = 3.224671290700398e-01,
                d3 = 2.445134137142996e+00, d4 = 3.754408661907416e+00;
            const p_low = 0.02425, p_high = 1 - 0.02425;
            let q, r;
            if (p < p_low) {
                q = Math.sqrt(-2 * Math.log(p));
                return (((((c1 * q + c2) * q + c3) * q + c4) * q + c5) * q + c6) /
                    ((((d1 * q + d2) * q + d3) * q + d4) * q + 1);
            } else if (p <= p_high) {
                q = p - 0.5;
                r = q * q;
                return (((((a1 * r + a2) * r + a3) * r + a4) * r + a5) * r + a6) * q /
                    (((((b1 * r + b2) * r + b3) * r + b4) * r + b5) * r + 1);
            } else {
                q = Math.sqrt(-2 * Math.log(1 - p));
                return -(((((c1 * q + c2) * q + c3) * q + c4) * q + c5) * q + c6) /
                        ((((d1 * q + d2) * q + d3) * q + d4) * q + 1);
            }
        }

        // 2. 二元正态分布累计概率 (Bivariate Normal CDF) - Drezner近似
        // 计算 P(X < x, Y < y) given correlation rho
        function bivariateNormalCDF(x, y, rho) {
            if (Math.abs(rho) >= 1) return 0; // 简化处理边界
            
            // 基础概率密度函数
            const phi = (z) => Math.exp(-z * z / 2) / Math.sqrt(2 * Math.PI);
            
            // Gauss-Legendre 权重和节点 (简化版，5点积分)
            const w = [0.24840615, 0.39233107, 0.21141819, 0.10324416, 0.02969605];
            const x_nodes = [0.10024215, 0.48281397, 1.06094980, 1.77972940, 2.66976040];
            
            const rho1 = Math.sqrt(1 - rho * rho);
            
            function prob(k, h, r) {
                const h1 = -h;
                const k1 = -k;
                
                return 0; 
            }
            return null; 
        }


        /* =========================================
        业务逻辑：Copula 计算与展示
        ========================================= */

        function calculateCopula() {
            const pdA = parseFloat(document.getElementById('copulaPdA').value) / 100;
            const pdB = parseFloat(document.getElementById('copulaPdB').value) / 100;
            const rho = parseFloat(document.getElementById('copulaRho').value);

            if (!pdA || !pdB || isNaN(rho)) {
                alert("请输入完整的违约概率和相关系数");
                return;
            }
            const thresholdA = normInv(pdA);
            const thresholdB = normInv(pdB);
            
            const steps = 100;
            const lowerBound = -6; // 负无穷近似
            const upperBound = thresholdA;
            const h = (upperBound - lowerBound) / steps;
            let sum = 0;

            const standardNormalPDF = (x) => Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
            const standardNormalCDF = (x) => {
                // Error function approximation
                const t = 1 / (1 + 0.2316419 * Math.abs(x));
                const d = 0.3989423 * Math.exp(-x * x / 2);
                const p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
                return x > 0 ? 1 - p : p;
            };

            for (let i = 0; i <= steps; i++) {
                const x = lowerBound + i * h;
                const conditionalProb = standardNormalCDF((thresholdB - rho * x) / Math.sqrt(1 - rho * rho));
                const jointDensity = conditionalProb * standardNormalPDF(x);
                
                let weight = (i === 0 || i === steps) ? 1 : (i % 2 === 0 ? 2 : 4);
                sum += weight * jointDensity;
            }

            const jointProb = (h / 3) * sum; // Simpson积分结果

            // 3. 衍生指标
            const indepProb = pdA * pdB; // 假设独立的联合概率
            const correlationImpact = jointProb / indepProb; // 相关性倍数

            const resultsHTML = `
                <div class="results-section show" id="copulaResults">
                    <div class="result-item" style="border-left: 4px solid #6c5ce7;">
                        <div class="result-label">联合违约概率 (Both Default)</div>
                        <div class="result-value" style="color: #6c5ce7;">${formatNumber(jointProb * 100, 4)}%</div>
                        <div class="result-formula">P(DefA ∩ DefB) | ρ=${rho}</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="result-item">
                            <div class="result-label">假设独立时概率</div>
                            <div class="result-value">${formatNumber(indepProb * 100, 4)}%</div>
                            <div style="font-size:12px; color:#999;">ρ=0 时的理论值</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">相关性影响倍数</div>
                            <div class="result-value" style="color: ${correlationImpact > 1 ? '#e74c3c' : '#27ae60'}">
                                ${formatNumber(correlationImpact, 2)}x
                            </div>
                            <div style="font-size:12px; color:#999;">风险放大了多少倍</div>
                        </div>
                    </div>

                    <div class="result-item" style="background: #fff8e1;">
                        <div class="result-label">风险传染分析</div>
                        <div style="font-size: 13px; color: #666; margin-top: 8px;">
                            如果资产 A 违约，资产 B 违约的条件概率飙升至：
                            <strong style="color:#d35400">${formatNumber((jointProb / pdA) * 100, 2)}%</strong>
                            <br>(原概率为 ${pdB * 100}%)
                        </div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">导出PNG</button>
                    </div>
                </div>
            `;

            document.getElementById('copulaResults').outerHTML = resultsHTML;
            addToHistory('Copula模型', `联合违约 ${formatNumber(jointProb * 100, 4)}%`);
        }
        // 提前还贷计算逻辑
        function calculateEarlyRepayment() {
            // 1. 获取输入 (单位转换：万元 -> 元)
            const principal = (parseFloat(document.getElementById('epPrincipal').value) || 0) * 10000;
            const rateYear = (parseFloat(document.getElementById('epRate').value) || 0) / 100;
            const yearsLeft = parseFloat(document.getElementById('epYears').value) || 0;
            const prepayAmt = (parseFloat(document.getElementById('epAmount').value) || 0) * 10000;
            const type = document.getElementById('epType').value;

            if (principal <= 0 || yearsLeft <= 0 || prepayAmt <= 0) {
                alert("请输入有效的剩余本金、期限和提前还款金额");
                return;
            }
            if (prepayAmt >= principal) {
                alert("提前还款金额大于等于剩余本金，请直接结清贷款即可。");
                return;
            }

            const rateMonth = rateYear / 12;
            const monthsLeft = Math.round(yearsLeft * 12);
            const newPrincipal = principal - prepayAmt; // 提前还款后的剩余本金

            // --- 计算原计划 (不提前还) ---
            let oldTotalInterest = 0;
            let oldMonthlyPayment = 0; // 仅用于等额本息展示
            
            if (type === 'equal-payment') {
                // 等额本息总利息 = [本金*月利率*(1+月利率)^n] / [(1+月利率)^n - 1] * n - 本金
                const pow = Math.pow(1 + rateMonth, monthsLeft);
                oldMonthlyPayment = (principal * rateMonth * pow) / (pow - 1);
                oldTotalInterest = (oldMonthlyPayment * monthsLeft) - principal;
            } else {
                // 等额本金总利息 = (n+1)*本金*月利率 / 2
                oldTotalInterest = (monthsLeft + 1) * principal * rateMonth / 2;
                // 等额本金首月还款用于展示
                oldMonthlyPayment = (principal / monthsLeft) + (principal * rateMonth);
            }

            // --- 方案 A：月供不变，缩短年限 (节省利息最多) ---
            let planA_Interest = 0;
            let planA_NewMonths = 0;
            let planA_Saved = 0;

            if (type === 'equal-payment') {
                // 保持原月供 oldMonthlyPayment，计算新的期数 n
                // 公式推导：n = log(PMT / (PMT - P_new * r)) / log(1+r)
                // 注意：这里用新本金
                const numerator = oldMonthlyPayment;
                const denominator = oldMonthlyPayment - (newPrincipal * rateMonth);
                
                if (denominator <= 0) {
                    // 极端情况：利息都覆盖不住，理论上不会发生，除非利率极高
                    planA_NewMonths = monthsLeft; 
                } else {
                    planA_NewMonths = Math.log(numerator / denominator) / Math.log(1 + rateMonth);
                }
                
                planA_NewMonths = Math.ceil(planA_NewMonths);
                planA_Interest = (oldMonthlyPayment * planA_NewMonths) - newPrincipal;
            } else {
                // 等额本金：保持每月本金还款额不变? 
                // 通常银行策略是：保持“每月还本金金额”增加（让总还款额接近原水平）或者单纯缩短期限
                // 这里采用标准做法：保持每月还本金金额不变(principal / monthsLeft)，从而缩短期限
                const monthlyPrincipal = principal / monthsLeft;
                planA_NewMonths = Math.ceil(newPrincipal / monthlyPrincipal);
                planA_Interest = (planA_NewMonths + 1) * newPrincipal * rateMonth / 2;
            }
            planA_Saved = oldTotalInterest - planA_Interest;


            // --- 方案 B：年限不变，减少月供 (减轻压力) ---
            let planB_Interest = 0;
            let planB_NewMonthly = 0;
            let planB_Saved = 0;

            if (type === 'equal-payment') {
                const pow = Math.pow(1 + rateMonth, monthsLeft);
                planB_NewMonthly = (newPrincipal * rateMonth * pow) / (pow - 1);
                planB_Interest = (planB_NewMonthly * monthsLeft) - newPrincipal;
            } else {
                // 等额本金
                planB_Interest = (monthsLeft + 1) * newPrincipal * rateMonth / 2;
                planB_NewMonthly = (newPrincipal / monthsLeft) + (newPrincipal * rateMonth); // 首月
            }
            planB_Saved = oldTotalInterest - planB_Interest;

            // --- 结果展示 ---
            const resultsHTML = `
                <div class="results-section show" id="epResults">
                    <div style="margin-bottom: 20px; font-size: 14px; color: #666;">
                        原计划剩余总利息: <strong>¥${formatNumber(oldTotalInterest)}</strong>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="result-item" style="border-left: 4px solid #f39c12; background: #fffdf5;">
                            <div class="result-label" style="color: #d35400; font-weight: bold;">方案一：缩短年限 (推荐)</div>
                            <div style="margin-top: 10px;">
                                <div style="font-size: 13px; color: #666;">节省利息</div>
                                <div class="result-value" style="color: #f39c12;">¥${formatNumber(planA_Saved)}</div>
                            </div>
                            <div style="margin-top: 10px; font-size: 13px;">
                                新月供: <strong>≈ ¥${formatNumber(oldMonthlyPayment)}</strong> (基本不变)<br>
                                新期限: <strong>${(planA_NewMonths/12).toFixed(1)} 年</strong><br>
                                <span style="color: #27ae60;">时间缩短: ${(yearsLeft - planA_NewMonths/12).toFixed(1)} 年</span>
                            </div>
                        </div>

                        <div class="result-item" style="border-left: 4px solid #1a6dff;">
                            <div class="result-label" style="color: #1a6dff; font-weight: bold;">方案二：减少月供</div>
                            <div style="margin-top: 10px;">
                                <div style="font-size: 13px; color: #666;">节省利息</div>
                                <div class="result-value" style="color: #1a6dff;">¥${formatNumber(planB_Saved)}</div>
                            </div>
                            <div style="margin-top: 10px; font-size: 13px;">
                                新月供: <strong>¥${formatNumber(planB_NewMonthly)}</strong> <span style="font-size:12px;color:#999;">(首月)</span><br>
                                新期限: <strong>${yearsLeft} 年</strong> (不变)<br>
                                <span style="color: #27ae60;">月供减少: ¥${formatNumber(oldMonthlyPayment - planB_NewMonthly)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="result-item" style="margin-top: 20px;">
                        <div class="result-label">决策建议</div>
                        <div style="color: #555; font-size: 14px; line-height: 1.6; margin-top: 5px;">
                            ${planA_Saved > planB_Saved 
                                ? `👉 <strong>缩短年限</strong>更划算，能多省利息 <strong>¥${formatNumber(planA_Saved - planB_Saved)}</strong>。` 
                                : `👉 两种方案利息节省相近。`}
                            <br>
                            如果您的目的是"不想给银行打工"，请选方案一。<br>
                            如果您当前"现金流压力大"，请选方案二。
                        </div>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">保存对比图</button>
                    </div>
                </div>
            `;

            document.getElementById('epResults').outerHTML = resultsHTML;
            addToHistory('提前还贷', `缩短年限省 ¥${formatNumber(planA_Saved)}`);
        }
        // --- 公积金计算器模块 ---

        // 1. 辅助功能：同步比例（点击"个人与公司比例保持一致"时触发）
        function syncGJJRates() {
            const pRate = document.getElementById('gjjPersonalRate').value;
            document.getElementById('gjjCompanyRate').value = pRate;
            // 给个小提示（可选）
            alert("已将公司缴存比例同步为 " + pRate + "%");
        }

        // 2. 核心计算逻辑
        function calculateGJJ() {
            // 获取输入值
            const base = parseFloat(document.getElementById('gjjBase').value);
            const pRate = parseFloat(document.getElementById('gjjPersonalRate').value) / 100;
            const cRate = parseFloat(document.getElementById('gjjCompanyRate').value) / 100;

            // 校验输入
            if (!base || base <= 0) {
                alert("请输入有效的缴纳基数");
                return;
            }

            // 计算逻辑
            // 注意：公积金计算通常精确到元或角分，这里保留两位小数
            // 个人月缴
            const monthlyPersonal = base * pRate;
            // 公司月缴
            const monthlyCompany = base * cRate;
            // 月总存缴
            const monthlyTotal = monthlyPersonal + monthlyCompany;

            // 年度数据
            const yearlyPersonal = monthlyPersonal * 12;
            const yearlyCompany = monthlyCompany * 12;
            const yearlyTotal = monthlyTotal * 12;

            // 生成结果 HTML
            const resultsHTML = `
                <div class="results-section show" id="gjjResults">
                    <div class="result-item" style="border-left: 4px solid #1a6dff; background: linear-gradient(135deg, rgba(26,109,255,0.08), rgba(26,109,255,0.02));">
                        <div class="result-label" style="color: #1a6dff; font-weight:bold;"> 年度总资产积累</div>
                        <div class="result-value" style="font-size: 24px; color: #333;">¥${formatNumber(yearlyTotal)}</div>
                        <div style="margin-top: 5px; font-size: 13px; color: #666;">
                            相当于每年多攒了一笔隐形存款
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                        <div class="result-item">
                            <div class="result-label">个人月缴 (从工资扣)</div>
                            <div class="result-value" style="color: #e67e22;">- ¥${formatNumber(monthlyPersonal)}</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                比例: ${(pRate*100)}%
                            </div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">公司月缴 (额外福利)</div>
                            <div class="result-value" style="color: #27ae60;">+ ¥${formatNumber(monthlyCompany)}</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                比例: ${(cRate*100)}%
                            </div>
                        </div>
                    </div>

                    <div class="result-item" style="margin-top: 15px;">
                        <div class="result-label">每月公积金账户入账</div>
                        <div class="result-value">¥${formatNumber(monthlyTotal)}</div>
                        
                        <div style="margin-top: 15px; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; display: flex;">
                            <div style="width: 50%; background: #e67e22; height: 100%;" title="个人部分"></div>
                            <div style="width: 50%; background: #27ae60; height: 100%;" title="公司部分"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 5px;">
                            <span>个人贡献</span>
                            <span>公司贡献</span>
                        </div>
                    </div>

                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToPNG()">保存结果</button>
                    </div>
                </div>
            `;

            // 渲染结果
            document.getElementById('gjjResults').outerHTML = resultsHTML;
            
            // 写入历史记录
            addToHistory('公积金计算', `月缴存 ¥${formatNumber(monthlyTotal)}`);
        }
        // Windows Resize 事件处理
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('hidden');
            }
        });

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter 快速计算
            if (e.ctrlKey && e.key === 'Enter') {
                const activeModule = document.querySelector('.module-content.active');
                const calculateBtn = activeModule.querySelector('.btn-calculate');
                if (calculateBtn) {
                    calculateBtn.click();
                }
            }
            
            // ESC 关闭侧边栏
            if (e.key === 'Escape' && window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
